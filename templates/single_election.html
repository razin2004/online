<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/svg+xml" href="/static/uploads/votecentral-icon.svg">

<meta charset="UTF-8" />
<title>{{ election.name }} â€” Secure Voting</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
  --bg:#020617;
  --panel:#0f172a;
  --border:rgba(148,163,184,.15);

  --blue:#38bdf8;
  --indigo:#6366f1;

  --green:#10b981;
  --red:#ef4444;
  --yellow:#facc15;

  --text:#f8fafc;
  --muted:#94a3b8;

  --radius-xl:24px;
  --radius-lg:18px;
}

/* ================= BASE ================= */
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Inter,Arial;}
body{
  min-height:100vh;
  background:
    radial-gradient(at 0% 0%,rgba(56,189,248,.08),transparent 50%),
    radial-gradient(at 100% 0%,rgba(99,102,241,.08),transparent 50%),
    var(--bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
  align-items:center;
}


/* ================= TOPBAR ================= */
.topbar{
  width:100%;
  padding:18px 26px;
  background:rgba(2,6,23,.88);
  backdrop-filter:blur(14px);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title{font-size:22px;font-weight:800;letter-spacing:.3px;}
.subtitle{color:#9ca3af;font-size:13px;opacity:.85}

/* ================= LAYOUT ================= */
.container{width:1150px;max-width:95%;margin-top:20px}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius-xl);
  padding:24px;
  margin-top:20px;
  box-shadow:0 20px 50px rgba(0,0,0,.35);
  transition:.25s ease;
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}
.section-title{
  font-size:17px;
  font-weight:700;
  margin-bottom:10px;
}

/* ================= STATUS BADGES ================= */
.badge{
  padding:6px 14px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  letter-spacing:.3px;
}

.badge-live{
  background:linear-gradient(
    135deg,
    rgba(16,185,129,.18),
    rgba(16,185,129,.08)
  );
  color:var(--green);
  position:relative;
  margin-left: -5px;
}


.badge-upcoming{
  background:rgba(250,204,21,.15);
  color:var(--yellow);
}

.badge-ended{
  background:rgba(148,163,184,.15);
  color:var(--muted);
}

.badge-locked{
  background:rgba(239,68,68,.15);
  color:var(--red);
}


/* ================= TIME PANEL ================= */
.time-panel{
  margin-top:14px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}
.time-card{
  background:linear-gradient(
    180deg,
    rgba(15,23,42,.95),
    rgba(2,6,23,.95)
  );
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  text-align:center;
}

.time-label{
  font-size:12px;
  color:#9ca3af;
  margin-bottom:4px;
}
.time-date{
  font-size:15px;
  font-weight:700;
}
.time-clock{
  font-size:22px;
  font-weight:800;
  margin-top:4px;
  color:var(--blue);
}


/* ================= SECURITY ================= */
.security-box{
  margin-top:14px;
  padding:12px;
  border-radius:14px;
  background:#020617;
  border:1px solid #334155;
  font-size:13px;
  opacity:.9;
}

/* ================= CANDIDATES ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:20px;
}

/* Tablet */
@media (max-width:1024px){
  .grid{
    grid-template-columns:repeat(2, 1fr);
  }
}

/* Mobile */
@media (max-width:600px){
  .grid{
    grid-template-columns:1fr;
  }
}


.candidate{
  background:linear-gradient(
    180deg,
    rgba(15,23,42,.95),
    rgba(2,6,23,.95)
  );
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:18px;
  transition:.25s ease;
}

.candidate:hover{
  transform:translateY(-4px);
  box-shadow:
    0 20px 50px rgba(0,0,0,.45),
    0 0 0 1px rgba(56,189,248,.2);
}

.candidate img{
  width:100%;
  aspect-ratio:1 / 1;
  object-fit:cover;
  border-radius:12px;
  border:1px solid #334155;
}

.candidate-name{font-size:16px;font-weight:700;margin-top:6px}
.party{font-size:13px;color:#93c5fd}
.desc{font-size:12px;color:#cbd5e1;margin-top:4px}

.selected{
  border:2px solid var(--blue);
  box-shadow:
    0 0 0 1px rgba(56,189,248,.3),
    0 20px 40px rgba(0,0,0,.5);
}





/* ================= BUTTONS ================= */
button{
  width:100%;
  margin-top:10px;
  padding:12px;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}
.btn-green{
  background:linear-gradient(135deg,var(--blue),var(--indigo));
  color:#fff;
}

.btn-green:hover{
  filter:brightness(1.05);
}

.btn-gray{
  background:#1e293b;
  color:var(--muted);
  border:1px solid var(--border);
}
.btn-disabled{
  background:#1e293b;
  color:var(--muted);
  opacity:.6;
  cursor:not-allowed;
}

/* ================= MODAL ================= */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(2,6,23,.85);
  backdrop-filter:blur(14px);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:.25s ease;
  z-index:4000;
}

.modal-bg.show{
  opacity:1;
  pointer-events:auto;
}

.modal{
  background:linear-gradient(
    180deg,
    #111827,
    #0f172a
  );
  border:1px solid var(--border);
  border-radius:28px;
  padding:34px;
  width:92%;
  max-width:420px;
  box-shadow:
    0 30px 80px rgba(0,0,0,.55);
  transform:scale(.96);
  transition:.25s ease;
}

.modal-bg.show .modal{
  transform:scale(1);
}


@keyframes scaleIn{
  from{transform:scale(.94);opacity:0}
  to{transform:scale(1);opacity:1}
}

.modal-icon{
  width:48px;
  height:48px;
  margin:0 auto 14px;
  border-radius:50%;
  background:rgba(56,189,248,.15);
  color:#38bdf8;
  display:flex;
  align-items:center;
  justify-content:center;
}
.back-btn{
  display:flex;
  align-items:center;
  gap:6px;
  padding:8px 14px;
  border-radius:14px;
  background:rgba(56,189,248,.12);
  border:1px solid rgba(56,189,248,.35);
  color:var(--blue);
  font-weight:700;
  text-decoration:none;
  transition:.2s ease;
}

.back-btn:hover{
  background:rgba(56,189,248,.25);
}
.reveal-option{
  margin-top:10px;
  font-size:13px;
  color:var(--muted);
  text-align:left;
}

.reveal-option input{
  margin-right:3px;
}
@media (max-width:600px){
  .back-btn{
    padding:6px 8px;
    font-size:13px;
    border-radius:12px;
  }

  .back-btn svg{
    width:14px;
    height:14px;
  }

  .title{
    font-size:18px;
  }

  .subtitle{
    font-size:11px;
  }
}

</style>
</head>

<body>

<div class="topbar">
  <div>
    <div class="title">{{ election.name }}</div>
    <div class="subtitle">{{ election.election_type|upper }} Election â€” Secure Verified Voting</div>
  </div>
  <div class="nav-actions">
    <a href="/voter/dashboard" class="back-btn">
  <svg width="16" height="16" viewBox="0 0 24 24"
       fill="none" stroke="currentColor" stroke-width="2">
    <line x1="19" y1="12" x2="5" y2="12"/>
    <polyline points="12 19 5 12 12 5"/>
  </svg>
  Dashboard
</a>


  </div>
</div>

<div class="container">

<div class="card">
  <div class="section-title">Election Status</div>
  {% if election.start_time and election.end_time %}
    <div id="status-badge" class="badge">Checkingâ€¦</div>
    <div id="countdown" class="countdown">Syncingâ€¦</div>
  {% else %}
    <div class="badge badge-locked">No schedule configured</div>
  {% endif %}
  <br>
<div style="margin-top:14px;font-size:14px;">
  <b>Total Votes:</b> {{ total_votes }}
</div>
{% if election.start_time or election.end_time %}
<div class="time-panel">

  {% if not has_started %}
  <!-- NOT STARTED -->
  <div class="time-card">
    <div class="time-label">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <circle cx="12" cy="12" r="10"/>
    <polyline points="12 6 12 12 16 14"/>
  </svg>
  Starts At
</div>

    <div class="time-date">{{ election.start_time[:10] }}</div>
    <div class="time-clock">{{ election.start_time[11:16] }}</div>
  </div>
  {% endif %}

  {% if has_started and not has_ended %}
  <!-- RUNNING -->
  <div class="time-card">
    <div class="time-label">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <circle cx="12" cy="12" r="10"/>
    <polyline points="12 6 12 12 16 14"/>
  </svg>
  Started At
</div>

    <div class="time-date">{{ election.start_time[:10] }}</div>
    <div class="time-clock">{{ election.start_time[11:16] }}</div>
  </div>

  <div class="time-card">
    <div class="time-label">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <rect x="6" y="6" width="12" height="12"/>
  </svg>
  Ends At
</div>

    <div class="time-date">{{ election.end_time[:10] }}</div>
    <div class="time-clock">{{ election.end_time[11:16] }}</div>
  </div>
  {% endif %}

  {% if has_ended %}
  <!-- ENDED -->
  <div class="time-card">
    <div class="time-label">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <rect x="6" y="6" width="12" height="12"/>
  </svg>
  Ended At
</div>

    <div class="time-date">{{ election.end_time[:10] }}</div>
    <div class="time-clock">{{ election.end_time[11:16] }}</div>
  </div>
  {% endif %}

</div>
{% endif %}


  {% if voted %}
  <div id="modificationContainer" style="margin-top:15px; border-top: 1px solid #334155; padding-top: 10px;">
<div id="editWindow" class="badge badge-locked">
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <rect x="3" y="11" width="18" height="11" rx="2"/>
    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
  </svg>
  Vote Status: Recorded
</div>

    
{% if voted and can_change %}
<div id="changeVoteBox" style="margin-top:8px;font-size:13px;">
  You can change your vote within
  <b class="timer-highlight">
    <span id="editTimerCountdown">{{ remaining_seconds }}</span>s
  </b>.
  <button id="changeVoteBtn">
    Change vote?
  </button>
</div>
{% endif %}

  </div>
  {% endif %}

<div class="security-box">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <rect x="3" y="11" width="18" height="11" rx="2"/>
    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
  </svg>
  End-to-end encrypted voting
  &nbsp;|&nbsp;
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px">
    <circle cx="12" cy="12" r="10"/>
    <polyline points="12 6 12 12 16 14"/>
  </svg>
  Modification window: {{ lock_seconds }}s
</div>

</div>

<div class="card">
  <div class="section-title">Select Your Candidate</div>
  <div class="grid">
    {% for c in candidates %}
<div class="candidate"
     id="cand-card-{{ c.id }}"
     data-id="{{ c.id }}">
      {% if c.photo %}<img src="/static/uploads/{{ c.photo }}">{% endif %}
      <div class="candidate-name">{{ c.name }}</div>
      {% if c.description %}<div class="desc">{{ c.description }}</div>{% endif %}
      
      <div class="status-indicator" id="status-ind-{{ c.id }}">
        
      </div>

      <form method="POST" action="/vote" class="voteForm" data-name="{{ c.name }}" data-id="{{ c.id }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="email" value="{{ email }}">
        <input type="hidden" name="election_id" value="{{ election.id }}">
        <input type="hidden" name="candidate_id" value="{{ c.id }}">
        <input type="hidden" name="confirm_flag" value="yes">
        <button type="submit" class="btn-green vote-btn" {% if voted and not change_mode %}disabled style="opacity:0.5"{% endif %}>
          Vote
        </button>
      </form>
    </div>
    {% endfor %}
  </div>
</div>

</div> 

<div class="modal-bg" id="modal">
  <div class="modal">
    <h3 id="modalName"></h3>
    <p style="margin-top:12px; font-size: 14px; color: #94a3b8;">
      Your vote will be recorded securely.<br>
      The window to change your mind closes soon.
    </p>
    <div class="reveal-option">
  <label>
    <input type="checkbox" id="revealVote">
    Show my selected candidate after voting
  </label>
</div>

    <div style="display:flex;justify-content:space-between; margin-top: 20px; gap: 10px;">
      <button class="btn-gray" onclick="closeModal()">Cancel</button>
      <button class="btn-green" id="confirmBtn">Confirm Vote</button>
    </div>
  </div>
</div>
<div class="modal-bg" id="lockedModal">
  <div class="modal">
    <h3>Vote permanently recorded</h3>
    <p style="margin-top:12px;font-size:14px;color:#94a3b8;">
      Modification window is closed.<br>
      Your vote is casted for <b id="lockedCandidateName"></b>.
    </p>
    <div style="margin-top:20px;">
      <button class="btn-green" onclick="closeLockedModal()">OK</button>
    </div>
  </div>
</div>


<script>

/* =====================================================
   STATE
===================================================== */
const CAN_CHANGE = {{ 'true' if can_change else 'false' }};
let remaining = {{ remaining_seconds | default(0) }};
let activeForm = null;

const REVEAL_VOTE = {{ 'true' if session.get("reveal_vote_" ~ election.id) else 'false' }};
const VOTED_ID = {{ session.get("voted_candidate_" ~ election.id) or 'null' }};

/* =====================================================
   DOM
===================================================== */
const changeBox   = document.getElementById("changeVoteBox");
const editBadge   = document.getElementById("editWindow");
const timerSpan   = document.getElementById("editTimerCountdown");
const voteBtns    = document.querySelectorAll(".vote-btn");

const modal       = document.getElementById("modal");
const modalTitle  = document.getElementById("modalName");
const modalText   = modal.querySelector("p");
const confirmBtn  = document.getElementById("confirmBtn");
const changeBtn   = document.getElementById("changeVoteBtn");
const revealOption = document.querySelector(".reveal-option");
const revealCheckbox = document.getElementById("revealVote");

/* =====================================================
   PREVIOUS VOTE HIGHLIGHT
===================================================== */
if (REVEAL_VOTE && VOTED_ID) {
  const card = document.querySelector(`#cand-card-${VOTED_ID}`);
  if (card) {
    card.classList.add("selected");
    const indicator = card.querySelector(".status-indicator");
    if (indicator) {
      indicator.innerHTML = '<div class="selected-badge">âœ” Vote Recorded</div>';
    }
  }
}
/* =====================================================
   LOCK BUTTONS IF ALREADY VOTED
===================================================== */

if (VOTED_ID && !CAN_CHANGE) {
  voteBtns.forEach(btn => {
    btn.disabled = true;
    btn.textContent = "Locked";
    btn.classList.add("btn-disabled");
  });
}

/* =====================================================
   REMOVE CHANGE BOX IF NOT ALLOWED
===================================================== */
if (!CAN_CHANGE && changeBox) {
  changeBox.remove();
}

/* =====================================================
   COUNTDOWN TIMER
===================================================== */
if (CAN_CHANGE && remaining > 0 && timerSpan) {
  const countdown = setInterval(() => {
    remaining--;
    timerSpan.textContent = remaining;

    if (remaining <= 0) {
      clearInterval(countdown);

      changeBox?.remove();
      editBadge.textContent = "ðŸ”’ Vote permanently recorded";
      editBadge.className = "badge badge-locked";

      voteBtns.forEach(btn => {
        btn.disabled = true;
        btn.textContent = "Locked";
        btn.classList.add("btn-disabled");
      });
    }
  }, 1000);
}

/* =====================================================
   OPEN MODAL (Reusable)
===================================================== */
function openModal(title, message, showCheckbox, buttonText) {
  
  modalTitle.innerHTML = title;
  modalText.innerHTML = message;

  revealOption.style.display = showCheckbox ? "block" : "none";
  revealCheckbox.checked = REVEAL_VOTE;

  confirmBtn.disabled = false;
  confirmBtn.textContent = buttonText;

  modal.classList.add("show");
}

/* =====================================================
   CLOSE MODAL
===================================================== */
function closeModal() {
  modal.classList.remove("show");
  revealCheckbox.checked = false;
}

/* =====================================================
   CHANGE VOTE FLOW
===================================================== */
if (changeBtn) {
  changeBtn.onclick = () => {

openModal(
  "Update your vote?",
  "You may change your vote only within the remaining time.<br><b>This action replaces your previous vote.</b>",
  false,   // âœ… show checkbox also during update
  "Update Vote"
);


    confirmBtn.onclick = () => {
      closeModal();

      document.querySelectorAll(".candidate")
        .forEach(c => c.classList.remove("selected"));

      document.querySelectorAll(".status-indicator")
        .forEach(i => i.innerHTML = "");

      voteBtns.forEach(btn => {
        btn.disabled = false;
        btn.classList.remove("btn-disabled");
        btn.textContent = "Vote";
      });
    };
  };
}

/* =====================================================
   FIRST VOTE FLOW
===================================================== */
document.querySelectorAll(".voteForm").forEach(form => {
  form.addEventListener("submit", e => {
    e.preventDefault();
    activeForm = form;

    openModal(
      "Confirm vote for<br><b>" + form.dataset.name + "</b>",
      "Your vote will be securely recorded.<br>" +
      (CAN_CHANGE
        ? "You may still update it within the remaining time."
        : "This vote will be permanent."
      ),
      true,
      "Confirm Vote"
    );

    confirmBtn.onclick = () => {
      const reveal = revealCheckbox.checked;

      if (reveal) {
        activeForm.insertAdjacentHTML(
          "beforeend",
          '<input type="hidden" name="reveal_vote" value="yes">'
        );
      }

      confirmBtn.disabled = true;
      confirmBtn.textContent = "Recordingâ€¦";
      activeForm.submit();
    };
  });
});

/* =====================================================
   LOCKED MODAL
===================================================== */
function closeLockedModal() {
  document.getElementById("lockedModal").classList.remove("show");
}
/* =====================================================
   ELECTION STATUS TIMER
===================================================== */

const startTime = "{{ election.start_time }}";
const endTime   = "{{ election.end_time }}";

if (startTime && endTime) {

  const badge = document.getElementById("status-badge");
  const clock = document.getElementById("countdown");

  const start = new Date(startTime).getTime();
  const end   = new Date(endTime).getTime();

  function format(ms){
    let s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600); s %= 3600;
    const m = Math.floor(s / 60);   s %= 60;
    return h + "h " + m + "m " + s + "s";
  }

  function updateStatus(){
    const now = Date.now();

    if (now < start) {
      badge.className = "badge badge-upcoming";
      badge.textContent = "Upcoming";
      clock.textContent = "Starts in: " + format(start - now);

    } else if (now <= end) {
      badge.className = "badge badge-live";
      badge.textContent = "Live";
      clock.textContent = "Ends in: " + format(end - now);

    } else {
      badge.className = "badge badge-ended";
      badge.textContent = "Ended";
      clock.textContent = "Election closed";
    }
  }

  updateStatus();
  setInterval(updateStatus, 1000);
}

</script>



</body>
</html>