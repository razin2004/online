<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/svg+xml" href="/static/uploads/votecentral-icon.svg">

<meta charset="UTF-8" />
<title>{{ election.name }} â€” Secure Voting</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
/* ================= BASE ================= */
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Inter,Arial;}
body{
  min-height:100vh;
  background:radial-gradient(1200px 600px at top,#020617,#000);
  color:#e5e7eb;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* ================= TOPBAR ================= */
.topbar{
  width:100%;
  padding:18px 26px;
  background:linear-gradient(180deg,#020617,#020617cc);
  border-bottom:1px solid #1f2937;
  display:flex;
  justify-content:space-between;
  align-items:center;
  backdrop-filter:blur(10px);
}
.title{font-size:22px;font-weight:800;letter-spacing:.3px;}
.subtitle{color:#9ca3af;font-size:13px;opacity:.85}

/* ================= LAYOUT ================= */
.container{width:1150px;max-width:95%;margin-top:20px}
.card{
  background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(2,6,23,.95));
  border:1px solid #1f2937;
  border-radius:20px;
  padding:20px;
  margin-top:16px;
  box-shadow:0 30px 60px rgba(0,0,0,.6);
  animation:fadeUp .4s ease;
}
@keyframes fadeUp{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}
.section-title{
  font-size:17px;
  font-weight:700;
  margin-bottom:10px;
}

/* ================= STATUS BADGES ================= */
.badge{
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}
.badge-live{background:#064e3b;color:#6ee7b7;box-shadow:0 0 0 1px #22c55e33}
.badge-upcoming{background:#1e3a8a;color:#bfdbfe}
.badge-ended{background:#7c2d12;color:#fca5a5}
.badge-locked{background:#334155;color:#cbd5e1}

/* ================= TIME PANEL ================= */
.time-panel{
  margin-top:14px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}
.time-card{
  background:linear-gradient(180deg,#020617,#020617aa);
  border:1px solid #334155;
  border-radius:16px;
  padding:14px;
  text-align:center;
}
.time-label{
  font-size:12px;
  color:#9ca3af;
  margin-bottom:4px;
}
.time-date{
  font-size:15px;
  font-weight:700;
}
.time-clock{
  font-size:22px;
  font-weight:800;
  margin-top:2px;
  color:#facc15;
}

/* ================= SECURITY ================= */
.security-box{
  margin-top:14px;
  padding:12px;
  border-radius:14px;
  background:#020617;
  border:1px solid #334155;
  font-size:13px;
  opacity:.9;
}

/* ================= CANDIDATES ================= */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
@media(max-width:768px){.grid{grid-template-columns:1fr}}

.candidate{
  background:#020617;
  border:1px solid #334155;
  border-radius:16px;
  padding:14px;
  position:relative;
  transition:.2s;
}
.candidate img{
  width:100%;
  aspect-ratio:1 / 1;
  object-fit:cover;
  border-radius:12px;
  border:1px solid #334155;
}

.candidate-name{font-size:16px;font-weight:700;margin-top:6px}
.party{font-size:13px;color:#93c5fd}
.desc{font-size:12px;color:#cbd5e1;margin-top:4px}

.selected{
  border:2px solid #22c55e;
  box-shadow:0 0 20px #22c55e55;
}




/* ================= BUTTONS ================= */
button{
  width:100%;
  margin-top:10px;
  padding:12px;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}
.btn-green{background:#16a34a;color:#fff}
.btn-green:hover{background:#22c55e}
.btn-gray{background:#6b7280}
.btn-disabled{background:#334155;color:#94a3b8;cursor:not-allowed}

/* ================= MODAL ================= */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:.25s;
  z-index:1000;
}
.modal-bg.show{opacity:1;pointer-events:auto}
.modal{
  background:#0f172a;
  border:1px solid #334155;
  border-radius:18px;
  padding:26px;
  width:380px;
  text-align:center;
  box-shadow:0 40px 80px rgba(0,0,0,.7);
}
.modal{
  animation:scaleIn .18s ease-out;
}

@keyframes scaleIn{
  from{transform:scale(.94);opacity:0}
  to{transform:scale(1);opacity:1}
}

.modal-icon{
  width:48px;
  height:48px;
  margin:0 auto 14px;
  border-radius:50%;
  background:rgba(56,189,248,.15);
  color:#38bdf8;
  display:flex;
  align-items:center;
  justify-content:center;
}

</style>
</head>

<body>

<div class="topbar">
  <div>
    <div class="title">{{ election.name }}</div>
    <div class="subtitle">{{ election.election_type|upper }} Election â€” Secure Verified Voting</div>
  </div>
  <div class="nav-actions">
    <a href="/voter/dashboard"><button class="top-btn btn-blue"> Back</button></a>

  </div>
</div>

<div class="container">

<div class="card">
  <div class="section-title">Election Status</div>
  {% if election.start_time and election.end_time %}
    <div id="status-badge" class="badge">Checkingâ€¦</div>
    <div id="countdown" class="countdown">Syncingâ€¦</div>
  {% else %}
    <div class="badge badge-locked">No schedule configured</div>
  {% endif %}
  <br>
<div style="margin-top:14px;font-size:14px;">
  <b>Total Votes:</b> {{ total_votes }}
</div>
{% if election.start_time or election.end_time %}
<div class="time-panel">

  {% if not has_started %}
  <!-- NOT STARTED -->
  <div class="time-card">
    <div class="time-label">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <circle cx="12" cy="12" r="10"/>
    <polyline points="12 6 12 12 16 14"/>
  </svg>
  Starts At
</div>

    <div class="time-date">{{ election.start_time[:10] }}</div>
    <div class="time-clock">{{ election.start_time[11:16] }}</div>
  </div>
  {% endif %}

  {% if has_started and not has_ended %}
  <!-- RUNNING -->
  <div class="time-card">
    <div class="time-label">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <circle cx="12" cy="12" r="10"/>
    <polyline points="12 6 12 12 16 14"/>
  </svg>
  Started At
</div>

    <div class="time-date">{{ election.start_time[:10] }}</div>
    <div class="time-clock">{{ election.start_time[11:16] }}</div>
  </div>

  <div class="time-card">
    <div class="time-label">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <rect x="6" y="6" width="12" height="12"/>
  </svg>
  Ends At
</div>

    <div class="time-date">{{ election.end_time[:10] }}</div>
    <div class="time-clock">{{ election.end_time[11:16] }}</div>
  </div>
  {% endif %}

  {% if has_ended %}
  <!-- ENDED -->
  <div class="time-card">
    <div class="time-label">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <rect x="6" y="6" width="12" height="12"/>
  </svg>
  Ended At
</div>

    <div class="time-date">{{ election.end_time[:10] }}</div>
    <div class="time-clock">{{ election.end_time[11:16] }}</div>
  </div>
  {% endif %}

</div>
{% endif %}


  {% if voted %}
  <div id="modificationContainer" style="margin-top:15px; border-top: 1px solid #334155; padding-top: 10px;">
<div id="editWindow" class="badge badge-locked">
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <rect x="3" y="11" width="18" height="11" rx="2"/>
    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
  </svg>
  Vote Status: Recorded
</div>

    
{% if voted and can_change %}
<div id="changeVoteBox" style="margin-top:8px;font-size:13px;">
  You can change your vote within
  <b class="timer-highlight">
    <span id="editTimerCountdown">{{ remaining_seconds }}</span>s
  </b>.
  <button id="changeVoteBtn">
    Change vote?
  </button>
</div>
{% endif %}

  </div>
  {% endif %}

<div class="security-box">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px">
    <rect x="3" y="11" width="18" height="11" rx="2"/>
    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
  </svg>
  End-to-end encrypted voting
  &nbsp;|&nbsp;
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px">
    <circle cx="12" cy="12" r="10"/>
    <polyline points="12 6 12 12 16 14"/>
  </svg>
  Modification window: {{ lock_seconds }}s
</div>

</div>

<div class="card">
  <div class="section-title">Select Your Candidate</div>
  <div class="grid">
    {% for c in candidates %}
    <div class="candidate {% if voted and voted.candidate_id == c.id %}selected{% endif %}" id="cand-card-{{ c.id }}">
      {% if c.photo %}<img src="/static/uploads/{{ c.photo }}">{% endif %}
      <div class="candidate-name">{{ c.name }}</div>
      {% if c.description %}<div class="desc">{{ c.description }}</div>{% endif %}
      
      <div class="status-indicator" id="status-ind-{{ c.id }}">
        {% if voted and voted.candidate_id == c.id %}
          <div class="selected-badge">âœ” Your Vote</div>
        {% endif %}
      </div>

      <form method="POST" action="/vote" class="voteForm" data-name="{{ c.name }}" data-id="{{ c.id }}">
        <input type="hidden" name="email" value="{{ email }}">
        <input type="hidden" name="election_id" value="{{ election.id }}">
        <input type="hidden" name="candidate_id" value="{{ c.id }}">
        <input type="hidden" name="confirm_flag" value="yes">
        <button type="submit" class="btn-green vote-btn" {% if voted and not change_mode %}disabled style="opacity:0.5"{% endif %}>
          Vote
        </button>
      </form>
    </div>
    {% endfor %}
  </div>
</div>

</div> 

<div class="modal-bg" id="modal">
  <div class="modal">
    <h3 id="modalName"></h3>
    <p style="margin-top:12px; font-size: 14px; color: #94a3b8;">
      Your vote will be recorded securely.<br>
      The window to change your mind closes soon.
    </p>
    <div style="display:flex;justify-content:space-between; margin-top: 20px; gap: 10px;">
      <button class="btn-gray" onclick="closeModal()">Cancel</button>
      <button class="btn-green" id="confirmBtn">Confirm Vote</button>
    </div>
  </div>
</div>
<div class="modal-bg" id="lockedModal">
  <div class="modal">
    <h3>Vote permanently recorded</h3>
    <p style="margin-top:12px;font-size:14px;color:#94a3b8;">
      Modification window is closed.<br>
      Your vote is casted for <b id="lockedCandidateName"></b>.
    </p>
    <div style="margin-top:20px;">
      <button class="btn-green" onclick="closeLockedModal()">OK</button>
    </div>
  </div>
</div>


<script>
/* =====================================================
   STATE (BACKEND-DRIVEN)
===================================================== */
const CAN_CHANGE = {{ 'true' if can_change else 'false' }};
let remaining = {{ remaining_seconds | default(0) }};
let activeForm = null;
let changeMode = false;

/* =====================================================
   DOM
===================================================== */
const changeBox   = document.getElementById("changeVoteBox");
const editBadge   = document.getElementById("editWindow");
const timerSpan   = document.getElementById("editTimerCountdown");
const voteBtns    = document.querySelectorAll(".vote-btn");
const modal       = document.getElementById("modal");
const modalTitle  = document.getElementById("modalName");
const modalText   = modal.querySelector("p");
const confirmBtn  = document.getElementById("confirmBtn");
const changeBtn   = document.getElementById("changeVoteBtn");

/* =====================================================
   INITIAL VISIBILITY
===================================================== */
if (!CAN_CHANGE && changeBox) {
  changeBox.remove();
}

/* =====================================================
   COUNTDOWN (DISPLAY ONLY)
===================================================== */
if (CAN_CHANGE && remaining > 0 && timerSpan) {

  const countdown = setInterval(() => {
    remaining--;
    timerSpan.textContent = remaining;

    if (remaining <= 0) {
      clearInterval(countdown);

      changeBox?.remove();
      editBadge.textContent = "ðŸ”’ Vote permanently recorded";
      editBadge.className = "badge badge-locked";

      voteBtns.forEach(btn => {
        btn.disabled = true;
        btn.textContent = "Locked";
        btn.classList.add("btn-disabled");
      });
    }
  }, 1000);
}

/* =====================================================
   CHANGE VOTE (CONFIRMATION)
===================================================== */
if (changeBtn) {
  changeBtn.onclick = () => {
    modalTitle.textContent = "Update your vote?";
    modalText.innerHTML =
      "You may change your vote only within the remaining time.<br>" +
      "<b>This action replaces your previous vote.</b>";

    confirmBtn.textContent = "Update Vote";
    modal.classList.add("show");

    confirmBtn.onclick = () => {
      modal.classList.remove("show");
      changeMode = true;

      document.querySelectorAll(".candidate")
        .forEach(c => c.classList.remove("selected"));

      document.querySelectorAll(".status-indicator")
        .forEach(i => i.innerHTML = "");

      voteBtns.forEach(btn => {
        btn.disabled = false;
        btn.classList.remove("btn-disabled");
        btn.textContent = "Vote";
      });
    };
  };
}

/* =====================================================
   VOTE SUBMIT
===================================================== */
document.querySelectorAll(".voteForm").forEach(form => {
  form.addEventListener("submit", e => {
    e.preventDefault();
    activeForm = form;

    modalTitle.innerHTML =
      "Confirm vote for<br><b>" + form.dataset.name + "</b>";

    modalText.innerHTML =
      "Your vote will be securely recorded.<br>" +
      (CAN_CHANGE ? "You may still update it within the remaining time."
                  : "This vote will be permanent.");

    confirmBtn.textContent = "Confirm Vote";
    modal.classList.add("show");

    confirmBtn.onclick = () => {
      confirmBtn.disabled = true;
      confirmBtn.textContent = "Recordingâ€¦";
      activeForm.submit();
    };
  });
});

/* =====================================================
   CLOSE MODAL
===================================================== */
function closeModal() {
  modal.classList.remove("show");
}

/* =====================================================
   LOCKED MESSAGE FROM BACKEND
===================================================== */
{% with messages = get_flashed_messages() %}
{% if "Modification window closed. Your vote is already cast." in messages %}
  const lockedModal = document.getElementById("lockedModal");
  const nameSpan = document.getElementById("lockedCandidateName");
  const votedCard = document.querySelector(".candidate.selected .candidate-name");

  if (votedCard) nameSpan.textContent = votedCard.textContent.trim();
  lockedModal.classList.add("show");
{% endif %}
{% endwith %}

function closeLockedModal() {
  document.getElementById("lockedModal").classList.remove("show");
}

/* =====================================================
   ELECTION STATUS TIMER (UNCHANGED)
===================================================== */
const startTime = "{{ election.start_time }}";
const endTime   = "{{ election.end_time }}";

if (startTime && endTime) {
  const badge = document.getElementById("status-badge");
  const clock = document.getElementById("countdown");
  const start = new Date(startTime).getTime();
  const end   = new Date(endTime).getTime();

  function fmt(ms){
    let s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600); s %= 3600;
    const m = Math.floor(s / 60);   s %= 60;
    return h + "h " + m + "m " + s + "s";
  }

  function tick(){
    const now = Date.now();
    if (now < start) {
      badge.className = "badge badge-upcoming";
      badge.innerHTML = `
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="margin-right:6px">
    <circle cx="12" cy="12" r="10"/>
    <polyline points="12 6 12 12 16 14"/>
  </svg>
  Upcoming
`;

      clock.textContent = "Starts in: " + fmt(start - now);
    } else if (now <= end) {
      badge.className = "badge badge-live";
      badge.innerHTML = `
  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"
    style="margin-right:6px">
    <circle cx="12" cy="12" r="10"/>
  </svg>
  Live
`;

      clock.textContent = "Ends in: " + fmt(end - now);
    } else {
      badge.className = "badge badge-ended";
      badge.innerHTML = `
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" style="margin-right:6px">
    <rect x="6" y="6" width="12" height="12"/>
  </svg>
  Ended
`;

      clock.textContent = "Election closed";
    }
  }

  tick();
  setInterval(tick, 1000);
}
</script>


</body>
</html>