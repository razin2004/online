<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OTP Verification ‚Äî Secure Access</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* (same styling ‚Äî unchanged for safety) */
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Arial;}

body{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at top,#020617,#000);
  color:#e5e7eb;
}

.container{
  width:430px;
  background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(2,6,23,.9));
  border:1px solid rgba(148,163,184,.2);
  border-radius:18px;
  padding:22px;
  box-shadow:
    0 40px 80px rgba(0,0,0,.55),
    inset 0 0 10px rgba(255,255,255,.05);
  backdrop-filter:blur(10px);
}

h2{text-align:center;margin-bottom:4px;font-weight:700;}
.sub{font-size:13px;color:#9ca3af;text-align:center;margin-bottom:10px;}

.msg{
  margin-top:10px;font-size:12px;border-radius:10px;
  padding:10px;border:1px solid transparent;
}
.success{background:#022c22;border-color:#22c55e;color:#bbf7d0;}
.error{background:#2c0a0a;border-color:#ef4444;color:#fecaca;}

.field{margin-top:12px;}
.field label{font-size:12px;color:#cbd5e1;}

.otp-input{
  width:100%;padding:12px;margin-top:6px;
  border-radius:12px;border:1px solid #334155;
  background:#020617;color:#e5e7eb;
  letter-spacing:3px;text-align:center;
}

.btn{
  width:100%;padding:11px;margin-top:14px;
  border:none;border-radius:12px;font-weight:700;
  cursor:pointer;
}

.primary{background:#22c55e;color:#022c22;}
.primary:hover{background:#16a34a;}

.link-text{margin-top:12px;font-size:12px;color:#9ca3af;text-align:center;}
.link-text a{color:#7dd3fc;text-decoration:none;}
.link-text a:hover{text-decoration:underline;}

.divider{height:1px;margin:12px 0;background:#1f2937;}
</style>
</head>

<body>

{% set messages = get_flashed_messages(with_categories=True) %}

<div class="container">

  <h2>üîê OTP Verification</h2>

  {% if context == "reset" %}
    <p class="sub">Enter the OTP sent to your admin email to continue.</p>

  {% elif context == "admin" %}
    <p class="sub">Enter the OTP sent to your admin registration email.</p>

  {% elif context == "voter" %}
    <p class="sub">Enter the OTP sent to your registered voter email.</p>

  {% else %}
    <p class="sub">Enter the verification code sent to your email.</p>
  {% endif %}


  {% for cat,msg in messages %}
    {% if cat == "otp_error" %}
      <div class="msg error">{{ msg }}</div>

    {% elif cat == "otp_success" %}
      <div class="msg success">{{ msg }}</div>
    {% endif %}
  {% endfor %}



  {# =========================
     OTP ENTRY FORM
     ========================= #}

  {% if not session.get('otp_reset_verified') %}

  <form method="POST" id="otpForm"
  action="{% if session.get('otp_context') == 'admin_reset' %}
            /admin/reset-verify
          {% elif context == 'voter' %}
            /voter/otp
          {% else %}
            /verify-otp
          {% endif %}">

    {% if email %}<input type="hidden" name="email" value="{{ email }}">{% endif %}
    {% if admin_code %}<input type="hidden" name="admin_code" value="{{ admin_code }}">{% endif %}

    <div class="field">
      <label>Enter 6-Digit OTP Code</label>
      <input type="text"
             name="otp"
             maxlength="6"
             class="otp-input"
             inputmode="numeric"
             pattern="[0-9]*"
             required>
    </div>

    <button class="btn primary" id="verifyBtn">
      Verify OTP
    </button>

    <p class="link-text" id="resendBox">
      Resend OTP in <span id="timer">30</span>s
    </p>

    {% if session.get('otp_context') == 'admin_reset' %}
      <p class="link-text">
        <a id="resendLink" href="/admin/reset-resend" style="display:none;">Resend OTP</a>
      </p>

    {% elif context == 'voter' %}
      <p class="link-text">
        <a id="resendLink" href="/voter/resend-otp" style="display:none;">Resend OTP</a>
      </p>

    {% else %}
      <p class="link-text">
        <a id="resendLink" href="/admin/register-resend" style="display:none;">Resend OTP</a>
      </p>
    {% endif %}
    </form>


  {% else %}



  {# =========================
     PASSWORD RESET MODE
     (OTP already verified)
     ========================= #}

  <h2>‚úî OTP Verified</h2>
  <p class="sub">Create your new secure password below.</p>

  <form method="POST" action="/admin/reset-password">

    <input type="hidden" name="email" value="{{ email }}">

    <div class="field">
      <label>New Password</label>
      <input type="password" name="password" required>
    </div>

    <div class="field">
      <label>Confirm Password</label>
      <input type="password" name="confirm" required>
    </div>

    <button class="btn primary">
      Update Password
    </button>
  </form>

  {% endif %}

  <div class="divider"></div>


  {% if session.get('otp_context') == "admin_register" %}
    <p class="link-text">Back to <a href="/?panel=register">Admin Registration</a></p>

  {% elif session.get('otp_context') == "admin_reset" %}
    <p class="link-text">Return to <a href="/">Admin Login</a></p>

  {% elif session.get('otp_context') == "voter_public" %}
    <p class="link-text">Back to <a href="/?panel=voter">Public Voter Login</a></p>

  {% elif session.get('otp_context') == "voter_private" %}
    <p class="link-text">Back to <a href="/?panel=voter">Private Voter Login</a></p>

  {% else %}
    <p class="link-text">Return to <a href="/">Login Page</a></p>
  {% endif %}

</div>


<script>
const form = document.getElementById("otpForm");
const btn = document.getElementById("verifyBtn");

if(form){
  form.addEventListener("submit",()=>{
    btn.disabled = true;
    btn.innerText = "Verifying‚Ä¶";
  });
}
let remaining = 30;
const timerSpan = document.getElementById("timer");
const resendLink = document.getElementById("resendLink");

const interval = setInterval(()=>{
  remaining--;
  timerSpan.innerText = remaining;

  if(remaining <= 0){
    clearInterval(interval);
    document.getElementById("resendBox").style.display = "none";
    resendLink.style.display = "block";
  }
},1000);

</script>


</body>
</html>
