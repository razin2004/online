<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin Panel | Secure Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ======================================================
   PREMIUM ADMIN DASHBOARD UI
   Compatible with existing HTML & JS
====================================================== */

/* ======================================================
   DESIGN TOKENS
====================================================== */
:root{
  --bg-dark:#020617;
  --bg-panel:#020617;
  --sidebar-bg:#0b1220;
  --card-bg:rgba(30,41,59,.72);
  --card-bg-hover:rgba(30,41,59,.88);
  --border:rgba(148,163,184,.12);

  --blue:#38bdf8;
  --indigo:#6366f1;
  --green:#10b981;
  --red:#ef4444;
  --yellow:#f59e0b;

  --text:#f8fafc;
  --muted:#94a3b8;
  --muted-soft:#64748b;

  --radius-xl:20px;
  --radius-lg:16px;
  --radius-md:12px;

  --shadow-soft:0 10px 30px rgba(0,0,0,.25);
  --shadow-hover:0 20px 60px rgba(0,0,0,.45);

  --blur:blur(14px);
  --mobile-nav-height: 70px;
  --bottom-safe-gap: 50px;
}
input,
select,
textarea{
  min-width:0;       /* üîë prevents grid overflow */
  max-width:100%;
}

/* ======================================================
   RESET & BASE
====================================================== */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Plus Jakarta Sans",system-ui,sans-serif;
}

html,body{
  height:100%;
  overflow-x: hidden;
}

body{
  background:
    radial-gradient(1200px 600px at 80% -10%,rgba(56,189,248,.08),transparent),
    linear-gradient(180deg,#020617,#020617);
  color:var(--text);
  display:flex;
  overflow-x:hidden;   /* ‚úÖ allow vertical scroll */
  overflow-y:auto;
  -webkit-font-smoothing:antialiased;
}
@media (max-width:768px){
  body{
    overflow: hidden;
  }
}

/* ======================================================
   SCROLLBAR (GLOBAL)
====================================================== */
*::-webkit-scrollbar{
  width:8px;
}
*::-webkit-scrollbar-thumb{
  background:rgba(148,163,184,.25);
  border-radius:20px;
}
*::-webkit-scrollbar-track{
  background:transparent;
}

/* ======================================================
   SIDEBAR
====================================================== */
.sidebar{
  width:260px;
  background:linear-gradient(180deg,#020617,#0b1220);
  border-right:1px solid var(--border);
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

.sidebar-brand{
  font-size:20px;
  font-weight:800;
  letter-spacing:.4px;
  background:linear-gradient(90deg,var(--blue),var(--indigo));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:6px;
}

.nav-menu{
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.nav-item{
  padding:12px 16px;
  border-radius:14px;
  cursor:pointer;
  color:var(--muted);
  font-weight:600;
  display:flex;
  align-items:center;
  gap:12px;
  transition:.25s ease;
}

.nav-item:hover{
  background:rgba(56,189,248,.08);
  color:var(--text);
}

.nav-item.active{
  background:linear-gradient(90deg,rgba(56,189,248,.18),transparent);
  color:var(--blue);
  box-shadow:inset 0 0 0 1px rgba(56,189,248,.25);
}

.sidebar-footer{
  margin-top:auto;
}

/* ======================================================
   MAIN WRAPPER
====================================================== */
.main-wrapper{
  flex:1;
  display:flex;
  flex-direction:column;
  min-height:100vh;   /* ‚úÖ SAFE */
}

@media(max-width:768px){
  .sidebar{display:none}
  .mobile-nav{display:flex}
  .top-header{padding:0 16px}
}
@media (max-width:768px){
/* Bottom scroll spacer */
.bottom-spacer{
  height: calc(
    var(--mobile-nav-height)
    + env(safe-area-inset-bottom)
    + 35px
  );
  flex-shrink: 0;
}

}
@media (max-width:768px){
  .view-container{
    padding:14px;
    padding-bottom:14px; /* üîë NORMAL padding only */
  }
}

@media (max-width: 768px){
  .modal-box{
    margin-bottom: calc(
      var(--mobile-nav-height)
      + env(safe-area-inset-bottom)
    
    );
  }
}

/* ======================================================
   TOP HEADER
====================================================== */
.top-header{
  height:72px;
  padding:0 28px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(2,6,23,.75);
  backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  z-index:50;
}

#view-title{
  font-size:18px;
  font-weight:700;
  letter-spacing:.3px;
}

/* ======================================================
   VIEW CONTAINERS
====================================================== */
.view-container{
  flex:1;
  padding:26px;
  overflow-y:auto;
  display:none;
  animation:fadeUp .35s ease;
}

.view-container.active{
  display:block;
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:translateY(0)}
}

/* ======================================================
   CARDS
====================================================== */
.card{
  background:linear-gradient(180deg,var(--card-bg),rgba(2,6,23,.85));
  border:1px solid var(--border);
  border-radius:var(--radius-xl);
  padding:20px;
  margin-bottom:18px;
  backdrop-filter:var(--blur);
  box-shadow:var(--shadow-soft);
  transition:.3s ease;
}

.card:hover{
  background:linear-gradient(180deg,var(--card-bg-hover),rgba(2,6,23,.9));
  box-shadow:var(--shadow-hover);
  transform:translateY(-2px);
}

/* ======================================================
   GRIDS
====================================================== */
.stat-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:18px;
}

.election-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:18px;
}

/* ======================================================
   TYPOGRAPHY INSIDE CARDS
====================================================== */
.card h1{
  font-size:32px;
  font-weight:800;
  margin-top:6px;
}

.card h3{
  font-size:16px;
  font-weight:700;
}

.card b{
  font-weight:700;
}

.card small{
  color:var(--muted);
  font-weight:600;
}

/* ======================================================
   BUTTONS
====================================================== */
.btn{
  padding:10px 18px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:700;
  letter-spacing:.2px;
  transition:.25s ease;
}

.btn-primary{
  background:linear-gradient(135deg,var(--blue),var(--indigo));
  color:#020617;
}

.btn-primary:hover{
  filter:brightness(1.1);
}

.btn-outline{
  background:rgba(255,255,255,.04);
  border:1px solid var(--border);
  color:var(--text);
}

.btn-outline:hover{
  background:rgba(255,255,255,.08);
}

.btn-danger{
  background:rgba(239,68,68,.15);
  color:var(--red);
  border:1px solid rgba(239,68,68,.35);
}

/* ======================================================
   BADGES
====================================================== */
.badge{
  padding:5px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  letter-spacing:.4px;
}

.badge-public{
  background:rgba(16,185,129,.18);
  color:#34d399;
}

.badge-private{
  background:rgba(99,102,241,.18);
  color:#818cf8;
}

/* ======================================================
   INPUTS & SELECTS
====================================================== */
input,select,textarea{
  width:100%;
  padding:11px 12px;
  border-radius:12px;
  background:rgba(2,6,23,.85);
  border:1px solid var(--border);
  color:var(--text);
  outline:none;
  transition:.25s ease;
}

input::placeholder{
  color:var(--muted-soft);
}

input:focus,select:focus,textarea:focus{
  border-color:var(--blue);
  box-shadow:0 0 0 2px rgba(56,189,248,.25);
}

/* ======================================================
   MOBILE NAV
====================================================== */

.mobile-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height: var(--mobile-nav-height);
  background:rgba(2,6,23,.9);
  backdrop-filter:blur(18px);
  border-top:1px solid var(--border);
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1000;
}


.m-nav-item{
  color:var(--muted);
  font-size:11px;
  font-weight:600;
  text-align:center;
  transition:.25s ease;
}

.m-nav-item.active{
  color:var(--blue);
  transform:translateY(-2px);
}

/* ======================================================
   MODALS
====================================================== */
.modal{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,.78);
  backdrop-filter:blur(8px);
  z-index:900;
}

.modal-box{
  width:460px;
  max-width:94%;
  background:linear-gradient(180deg,#020617,#020617);
  border:1px solid var(--border);
  border-radius:20px;
  padding:20px;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 40px 120px rgba(0,0,0,.8);
}

/* ======================================================
   RESPONSIVE
====================================================== */
.mobile-nav{
  display:none;
}

@media(max-width:768px){
  .sidebar{display:none}
  .mobile-nav{display:flex}
  .top-header{padding:0 16px}
}
/* Auto-hide animation for mobile nav */
.mobile-nav{
  transition: transform .35s ease, opacity .35s ease;
  will-change: transform, opacity;
}

.mobile-nav.hidden{
  transform: translateY(110%);
  opacity: 0;
}
/* ======================================================
   EMPTY STATES
====================================================== */
.empty-state{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:46px 24px;
  border:1px dashed rgba(148,163,184,.25);
  border-radius:18px;
  background:rgba(2,6,23,.35);
  color:var(--muted);
  animation:fadeUp .35s ease;
}

.empty-icon{
  font-size:36px;
  margin-bottom:12px;
  opacity:.9;
}

.empty-title{
  font-size:15px;
  font-weight:700;
  color:var(--text);
  margin-bottom:4px;
}

.empty-text{
  font-size:13px;
  max-width:320px;
  line-height:1.5;
}

.empty-action{
  margin-top:14px;
}
@media(max-width:768px){
  .empty-state{
    padding:36px 18px;
  }
  .empty-text{
    font-size:12.5px;
  }
}
.m-nav-item.active{
  color:var(--blue);
  transform:translateY(-1px);
}

/* ======================================================
   DIRECTIONAL VIEW TRANSITIONS
====================================================== */
.view-container{
  position:relative;
}

.view-enter-right{
  animation:slideInRight .35s ease forwards;
}

.view-enter-left{
  animation:slideInLeft .35s ease forwards;
}

@keyframes slideInRight{
  from{opacity:0; transform:translateX(24px)}
  to{opacity:1; transform:translateX(0)}
}

@keyframes slideInLeft{
  from{opacity:0; transform:translateX(-24px)}
  to{opacity:1; transform:translateX(0)}
}
/* ======================================================
   BUTTON LOADING STATES
====================================================== */
.btn{
  position:relative;
}

.btn.loading{
  pointer-events:none;
  opacity:.7;
}

.btn.loading::after{
  content:"";
  width:16px;
  height:16px;
  border:2px solid rgba(255,255,255,.4);
  border-top-color:#fff;
  border-radius:50%;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  animation:spin .8s linear infinite;
}

@keyframes spin{
  to{ transform:translate(-50%,-50%) rotate(360deg) }
}
.btn-danger.loading::after{
  border-top-color:var(--red);
}
/* ======================================================
   DISABLED BUTTON STATES (GLOBAL)
====================================================== */
.btn:disabled,
.btn[disabled]{
  cursor:not-allowed;
  opacity:.45;
  filter:grayscale(.6);
  box-shadow:none !important;
  transform:none !important;
}

/* Prevent hover / active effects */
.btn:disabled:hover{
  background:inherit;
  filter:grayscale(.6);
}

/* Primary disabled */
.btn-primary:disabled{
  background:linear-gradient(135deg,#475569,#64748b);
  color:#e5e7eb;
}

/* Outline disabled */
.btn-outline:disabled{
  background:rgba(255,255,255,.03);
  color:var(--muted);
  border-color:rgba(148,163,184,.2);
}

/* Danger disabled */
.btn-danger:disabled{
  background:rgba(239,68,68,.12);
  color:#fca5a5;
  border-color:rgba(239,68,68,.25);
}

/* Tooltip-style hint (uses title attribute) */
.btn:disabled[title]{
  position:relative;
}

.btn:disabled[title]:hover::after{
  content:attr(title);
  position:absolute;
  bottom:110%;
  left:50%;
  transform:translateX(-50%);
  background:rgba(15,23,42,.95);
  color:#f8fafc;
  font-size:11px;
  font-weight:600;
  padding:6px 10px;
  border-radius:8px;
  white-space:nowrap;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
  pointer-events:none;
  opacity:1;
  z-index:999;
}

.btn:disabled[title]:hover::before{
  content:"";
  position:absolute;
  bottom:100%;
  left:50%;
  transform:translateX(-50%);
  border:6px solid transparent;
  border-top-color:rgba(15,23,42,.95);
}
.profile-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 0;
  border-bottom:1px dashed var(--border);
}

.profile-row:last-child{
  border-bottom:none;
}

.profile-label{
  color:var(--muted);
  font-size:13px;
}

.profile-value{
  font-weight:600;
}

.edit-btn{
  background:none;
  border:none;
  cursor:pointer;
  color:var(--blue);
  font-size:14px;
}

.profile-input{
  display:none;
  margin-top:6px;
}
.stat-breakdown{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}

.chip{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
  letter-spacing:.3px;
}

.chip-public{
  background:rgba(16,185,129,.18);
  color:#34d399;
}

.chip-private{
  background:rgba(99,102,241,.18);
  color:#818cf8;
}

.chip-running{
  background:rgba(16,185,129,.18);
  color:#34d399;
}

.chip-upcoming{
  background:rgba(245,158,11,.18);
  color:#fbbf24;
}

.chip-ended{
  background:rgba(239,68,68,.18);
  color:#f87171;
}
/* ======================================================
   DASHBOARD ALERT SEVERITY
====================================================== */
.alert-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
  transition:.25s ease;
}

.alert-item:hover{
  background:rgba(255,255,255,.05);
}

.alert-icon{
  font-size:18px;
}

.alert-text{
  font-size:14px;
  font-weight:600;
}

.alert-critical{
  color:#f87171;
}

.alert-warning{
  color:#fbbf24;
}

.alert-info{
  color:#60a5fa;
}
/* EXTRA-STRONG election name inside alerts */
.alert-text b{
  font-weight:900;              /* heavier than default bold */
  color:#f6f8f8;                /* max contrast */
  letter-spacing:.3px;
  text-shadow:
    0 0 6px rgba(255, 255, 255, 0.888),
}
@media (max-width: 768px){

  :root{
    --radius-xl:16px;
    --radius-lg:14px;
    --radius-md:10px;
  }
}

@media (max-width: 768px){

  .card{
    padding:14px;
    margin-bottom:12px;
  }

  .stat-grid,
  .election-grid{
    gap:12px;
  }
}
@media (max-width: 768px){

  .card h1{
    font-size:22px;
  }

  .card h3{
    font-size:14px;
  }

  .card b{
    font-size:14px;
  }

  .card small{
    font-size:11px;
  }

  .alert-text{
    font-size:13px;
  }

  .empty-title{
    font-size:14px;
  }

  .empty-text{
    font-size:12px;
  }
}
@media (max-width: 768px){

  .btn{
    padding:8px 14px;
    font-size:12px;
    border-radius:10px;
  }

  .btn-primary,
  .btn-outline,
  .btn-danger{
    font-weight:600;
  }
}
@media (max-width: 768px){

  .top-header{
    height:58px;
    padding:0 14px;
    position:sticky;
    top:0;
    isolation:isolate; 
  }

  #view-title{
    font-size:15px;
  }

  .mobile-nav{
    height:58px;
  }

  .m-nav-item{
    font-size:10px;
  }
}
@media (max-width: 768px){

  .election-grid{
    grid-template-columns:1fr;
  }

  .stat-grid{
    grid-template-columns:1fr 1fr;
  }
}
@media (max-width: 768px){

  .card{
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }

  .card:hover{
    transform:none;
  }
}
@media (max-width: 768px){
  .modal{
    align-items:center;     /* ‚úÖ center vertically */
    justify-content:center; /* ‚úÖ center horizontally */
  }
}
@media (max-width: 768px){
  .modal-box{
    width:92%;
    max-width:420px;
    border-radius:18px;
    padding:16px;
    max-height:78vh;
  }
}

@media (max-width: 768px){

  .chip,
  .badge{
    font-size:10px;
    padding:3px 8px;
  }
}
@media (max-width: 768px){

  .alert-item{
    padding:6px 8px;
  }

  .alert-icon{
    font-size:16px;
  }
}
@media (max-width: 768px){
  input, select, textarea{
    padding:9px 10px;
    font-size:13px;
  }
}
@media (max-width: 480px){

  /* Filter bars stack instead of overflow */
  .view-container .card > div[style*="grid-template-columns"]{
    grid-template-columns: 1fr !important;
  }

  .view-container .card > div{
    row-gap:10px;
  }
}
.card{
  max-width:100%;
  overflow:hidden;
}
.modal-box{
  box-sizing:border-box;
}

.modal-box .card{
  max-width:100%;
}
@media (max-width: 480px){
  .modal-box .card{
    padding:10px !important;
  }
}
@media (max-width: 480px){
  input, select{
    height:40px;
    font-size:13px;
    line-height:1.2;
  }
}
/* Overview mini metrics */
.ov-metrics{
  margin-top:4px;
  margin-bottom: 4px;
  font-size:12px;
  font-weight:600;
  color:var(--muted);
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.ov-metrics span{
  white-space:nowrap;
}
@media (max-width:768px){
  .ov-metrics{
    font-size:11px;
    gap:8px;
  }
}
/* ================= STATUS CHIPS ================= */
.status-chip{
  margin-top: 8px;
  margin-left: -4px;
  padding:4px 6px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  letter-spacing:.3px;
  text-transform:uppercase;
  white-space:nowrap;
}

.status-upcoming{
  background:rgba(56,189,248,.18);
  color:#38bdf8;
}

.status-running{
  background:rgba(16,185,129,.18);
  color:#10b981;
}

.status-ended{
  background:rgba(148,163,184,.18);
  color:#94a3b8;
}
/* ======================================================
   PREMIUM TIME & VOTE DISPLAY
====================================================== */

/* Time wrapper */
.time-box{
  margin-top:6px;
  margin-left: -4px;
  margin-bottom: 3px;
  padding:8px 12px;
  border-radius:12px;
  background:rgba(2,6,23,.55);
  border:1px solid rgba(148,163,184,.18);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-size:12px;
}

/* Countdown text */
.time-label{
  color:var(--muted);
  font-weight:600;
}

.time-value{
  font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
  font-weight:800;
  letter-spacing:.6px;
}

/* Color sync with status */
.time-upcoming .time-value{ color:var(--blue); }
.time-running  .time-value{ color:var(--green); }
.time-ended    .time-value{ color:#94a3b8; }

/* Votes pill */
/* ======================================================
   PREMIUM TOTAL VOTES PILL (IMPROVED)
====================================================== */

.vote-pill{
  margin-top:10px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:7px 14px;
  border-radius:999px;

  font-size:12px;
  font-weight:900;
  letter-spacing:.4px;

  background:linear-gradient(
    135deg,
    rgba(16,185,129,.28),
    rgba(16,185,129,.12)
  );
  color:#ecfdf5;

  border:1px solid rgba(16,185,129,.45);
  box-shadow:
    inset 0 0 0 1px rgba(16,185,129,.15),
    0 6px 18px rgba(0,0,0,.35);

  white-space:nowrap;
}

/* Zero votes ‚Äî neutral & calm */
.vote-pill.zero{
  background:linear-gradient(
    135deg,
    rgba(148,163,184,.22),
    rgba(148,163,184,.10)
  );
  color:#e5e7eb;
  border-color:rgba(148,163,184,.35);
  box-shadow:
    inset 0 0 0 1px rgba(148,163,184,.15),
    0 4px 14px rgba(0,0,0,.3);
}

/* Results tab emphasis */
[data-result-card] .vote-pill{
  margin-top:12px;
  font-size:13px;
  padding:8px 16px;
}


</style>
</head>

<body>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar">
  <div class="sidebar-brand">VOTEGUARD ADMIN</div>
  <ul class="nav-menu">
    <li class="nav-item active" onclick="switchView('dashboard')">üìä Dashboard</li>
    <li class="nav-item" onclick="switchView('overview')">üëÅÔ∏è Overview</li>
    <li class="nav-item" onclick="switchView('elections')">üó≥Ô∏è Elections</li>
    <li class="nav-item" onclick="switchView('results')">üèÜ Results</li>
    <li class="nav-item" onclick="switchView('profile')">üë§ Profile</li>
  </ul>

  <div class="sidebar-footer">
<button class="btn btn-danger" style="width:100%" onclick="openLogoutConfirm()">
  Logout
</button>


  </div>
</aside>

<!-- ================= MOBILE NAV ================= -->
<nav class="mobile-nav">
  <div class="m-nav-item" data-view="dashboard" onclick="switchView('dashboard')">üìä<br>Dash</div>
  <div class="m-nav-item" data-view="overview" onclick="switchView('overview')">üëÅÔ∏è<br>View</div>
  <div class="m-nav-item" data-view="elections" onclick="switchView('elections')">üó≥Ô∏è<br>Vote</div>
  <div class="m-nav-item" data-view="results" onclick="switchView('results')">üèÜ<br>Win</div>
  <div class="m-nav-item" data-view="profile" onclick="switchView('profile')">üë§<br>Me</div>
</nav>


<!-- ================= MAIN ================= -->
<main class="main-wrapper">

<header class="top-header">
  <h2 id="view-title">Dashboard</h2>

  <div id="header-actions" style="display:flex;gap:10px">
    <button
      id="newElectionBtn"
      class="btn btn-primary"
      onclick="openModal('createElectionModal')">
      + New Election
    </button>
  </div>
</header>


<!-- ================= DASHBOARD ================= -->
<section id="dashboard" class="view-container">
  <div class="stat-grid">

    <!-- TOTAL -->
    <div class="card">
      <small>Total Elections</small>
      <h1>{{ elections|length }}</h1>
      <div class="note">All elections created</div>
    </div>

    <!-- RUNNING -->
    <div class="card">
      <small>Running Elections</small>
      <h1 style="color:var(--green)">
        {{ elections|selectattr("is_running")|list|length }}
      </h1>

      <div class="stat-breakdown">
        <span class="chip chip-public">
          Public:
          {{
            elections
            | selectattr("is_running")
            | selectattr("election_type","equalto","public")
            | list | length
          }}
        </span>

        <span class="chip chip-private">
          Private:
          {{
            elections
            | selectattr("is_running")
            | selectattr("election_type","equalto","private")
            | list | length
          }}
        </span>
      </div>
    </div>

    <!-- PUBLIC -->
    <div class="card">
      <small>Public Elections</small>
      <h1 style="color:#34d399">
        {{ elections|selectattr("election_type","equalto","public")|list|length }}
      </h1>

      <div class="stat-breakdown">
        <span class="chip chip-running">
          Running:
          {{
            elections
            | selectattr("election_type","equalto","public")
            | selectattr("is_running")
            | list | length
          }}
        </span>

        <span class="chip chip-upcoming">
          Upcoming:
          {{ elections
            | selectattr("election_type","equalto","public")
            | selectattr("is_upcoming")
            | list | length }}
        </span>

        <span class="chip chip-ended">
          Ended:
          {{
            elections
            | selectattr("election_type","equalto","public")
            | selectattr("is_ended")
            | list | length
          }}
        </span>
      </div>
    </div>

    <!-- PRIVATE -->
    <div class="card">
      <small>Private Elections</small>
      <h1 style="color:#818cf8">
        {{ elections|selectattr("election_type","equalto","private")|list|length }}
      </h1>

      <div class="stat-breakdown">
        <span class="chip chip-running">
          Running:
          {{
            elections
            | selectattr("election_type","equalto","private")
            | selectattr("is_running")
            | list | length
          }}
        </span>

        <span class="chip chip-upcoming">
          Upcoming:
          {{
            elections
            | selectattr("election_type","equalto","private")
            | selectattr("is_upcoming")
            | list | length
          }}
        </span>

        <span class="chip chip-ended">
          Ended:
          {{
            elections
            | selectattr("election_type","equalto","private")
            | selectattr("is_ended")
            | list | length
          }}
        </span>
      </div>
    </div>

  </div>
{% set alerts = [] %}

{# üî¥ Critical: Running but no votes #}
{% for e in elections if e.is_running and e.total_votes == 0 %}
  {% set _ = alerts.append({
    "level": "critical",
    "icon": "üî¥",
    "text": "Running election <b>" ~ e.name ~ "</b> has no votes yet",
    "action": "candidates",
    "id": e.id,
    "name": e.name,
    "start": e.start_time,
    "end": e.end_time
  }) %}
{% endfor %}

{# üü° Warning: Private with empty whitelist #}
{% for e in elections if e.election_type == "private" and e.whitelist|length == 0 %}
  {% set _ = alerts.append({
    "level": "warning",
    "icon": "üü°",
    "text": "Private election <b>" ~ e.name ~ "</b> has an empty whitelist",
    "action": "whitelist",
    "id": e.id,
    "name": e.name,
    "start": e.start_time,
    "end": e.end_time
  }) %}
{% endfor %}

{# üîµ Info: Starting soon #}
{% for e in elections if e.is_upcoming and e.start_time %}
  {% set start_ts = datetime.fromisoformat(e.start_time) %}
  {% if (start_ts - datetime.now()).total_seconds() <= 86400 %}
    {% set _ = alerts.append({
      "level": "info",
      "icon": "üîµ",
      "text": "Election <b>" ~ e.name ~ "</b> starts within 24 hours",
      "action": "scroll",
      "id": e.id
    }) %}
  {% endif %}
{% endfor %}

{% if alerts|length > 0 %}
<div class="card">
  <h3 style="color:var(--yellow)">‚ö†Ô∏è Attention Needed</h3>

  <ul style="margin-top:10px;line-height:1.8;list-style:none;padding-left:0">
    {% for a in alerts %}
      <li
        class="alert-item alert-{{ a.level }}"
        onclick="handleDashboardAlert(
          '{{ a.action }}',
          '{{ a.id }}',
          '{{ a.name|default('') }}',
          '{{ a.start|default('') }}',
          '{{ a.end|default('') }}'
        )"
      >
        <span class="alert-icon">{{ a.icon }}</span>
        <span class="alert-text">{{ a.text | safe }}</span>

      </li>
    {% endfor %}
  </ul>
</div>
{% endif %}

  <!-- QUICK ACTIONS -->
  <div class="card">
    <h3>Quick Actions</h3>
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:10px">
      <button class="btn btn-primary" onclick="openModal('createElectionModal')">
        + Create Election
      </button>
      <button class="btn btn-outline" onclick="switchView('elections')">
        Manage Elections
      </button>
      <button class="btn btn-outline" onclick="switchView('results')">
        View Results
      </button>
    </div>
  </div>
  <div class="bottom-spacer"></div>
</section>


<!-- ================= OVERVIEW ================= -->
<section id="overview" class="view-container">
<div class="card">
  <div style="display:grid;grid-template-columns:1fr 160px 160px;gap:12px">
    <input id="overviewSearch" placeholder="Search elections...">

    <select id="overviewTypeFilter">
      <option value="all">All Types</option>
      <option value="public">Public</option>
      <option value="private">Private</option>
    </select>

    <select id="overviewStatusFilter">
      <option value="all">All Status</option>
      <option value="running">Running</option>
      <option value="upcoming">Upcoming</option>
      <option value="ended">Ended</option>
    </select>
  </div>
</div>


    <div class="election-grid" id="overviewGrid">
      {% for e in elections %}
      <div class="card"
           data-ov-card
           data-type="{{ e.election_type }}"
           data-name="{{ e.name|lower }}"
           data-code="{{ e.public_code|lower if e.public_code }}"
           data-start="{{ e.start_time }}"
           data-end="{{ e.end_time }}">
        <b>{{ e.name }}</b>
        <span class="badge {{ 'badge-public' if e.election_type=='public' else 'badge-private' }}">
          {{ e.election_type|upper }}
        </span>
        <div class="status-chip" data-status-chip></div>
        <div class="time-box">
  <span class="time-label">Time</span>
  <span class="time-value countdown-timer"></span>
</div>

        <div class="ov-metrics">
  <span>Candidates: {{ e.candidates|length }}</span>
  <span>Votes: {{ e.total_votes }}</span>


  {% if e.election_type == "private" %}
    <span>Whitelist: {{ e.whitelist|length }}</span>
  {% endif %}
</div>

        <a href="/admin/toggle-results/{{ e.id }}">
          <button class="btn btn-outline">
            {% if e.result_visible %}Hide Results{% else %}Show Results{% endif %}
          </button>
        </a>
      </div>
      {% endfor %}
      
    </div>
  </div>
  <div class="bottom-spacer"></div>
</section>

<!-- ================= ELECTIONS ================= -->
<section id="elections" class="view-container">
{% if elections|length == 0 %}
<div class="empty-state">
  <div class="empty-icon">üó≥Ô∏è</div>
  <div class="empty-title">No elections created</div>
  <div class="empty-text">
    Elections will appear here once you create one.
    Start by defining election type, schedule, and candidates.
  </div>
  <div class="empty-action">
    <button class="btn btn-primary" onclick="openModal('createElectionModal')">
      + Create Election
    </button>
  </div>
</div>
{% endif %}

  <div class="card">
  <div style="display:grid;grid-template-columns:1fr 160px 160px;gap:12px">
    <input id="electionSearch" placeholder="Search elections...">

    <select id="electionTypeFilter">
      <option value="all">All Types</option>
      <option value="public">Public</option>
      <option value="private">Private</option>
    </select>

    <select id="electionStatusFilter">
      <option value="all">All Status</option>
      <option value="running">Running</option>
      <option value="upcoming">Upcoming</option>
      <option value="ended">Ended</option>
    </select>
  </div>
</div>

  <div class="election-grid">
    {% for e in elections %}
<div class="card"
     data-election-card
     data-type="{{ e.election_type }}"
     data-start="{{ e.start_time }}"
     data-end="{{ e.end_time }}">

      <div style="display:flex;align-items:center;gap:8px">
  <h3 style="margin:0">{{ e.name }}</h3>
  <span class="badge {{ 'badge-public' if e.election_type=='public' else 'badge-private' }}">
    {{ e.election_type|upper }}
  </span>
</div>
<div
  class="status-chip"
  data-status-chip
></div>

      <div class="time-box">
  <span class="time-label">Time</span>
  <span class="time-value countdown-timer"></span>
</div>

      <p class="election-state-note" hidden></p>
      <button class="btn btn-primary"
        onclick="
          rememberModal('candidates','{{ e.id }}','{{ e.name }}');
          openManageCandidates(
            '{{ e.id }}',
            '{{ e.name }}',
            '{{ e.start_time }}',
            '{{ e.end_time }}'
          );
        ">
        Manage Candidates
      </button>


      {% if e.election_type == "private" %}
      <button class="btn btn-outline"
        onclick="
          rememberModal('whitelist','{{ e.id }}','{{ e.name }}');
          openWhitelist(
            '{{ e.id }}',
            '{{ e.name }}',
            '{{ e.start_time }}',
            '{{ e.end_time }}'
          );
        ">
        Whitelist
      </button>


      {% endif %}
      <button class="btn btn-outline" onclick="openEditElection('{{ e.id }}','{{ e.name }}','{{ e.start_time }}','{{ e.end_time }}')">Edit</button>
    </div>
    {% endfor %}
  </div>
  <div class="bottom-spacer"></div>
</section>

<!-- ================= RESULTS ================= -->
<section id="results" class="view-container">
{% set total_votes = elections | sum(attribute='total_votes') %}

{% if total_votes == 0 %}
<div class="empty-state">
  <div class="empty-icon">üìä</div>
  <div class="empty-title">No votes recorded</div>
  <div class="empty-text">
    Voting has not started yet or no votes have been cast.
    Results will appear automatically once voting begins.
  </div>
</div>
{% endif %}

  <!-- FILTER BAR -->
  <div class="card">
    <div style="display:grid;grid-template-columns:1fr 160px 160px;gap:12px">
      <input id="resultsSearch" placeholder="Search elections...">

      <select id="resultsTypeFilter">
        <option value="all">All Types</option>
        <option value="public">Public</option>
        <option value="private">Private</option>
      </select>

      <select id="resultsStatusFilter">
        <option value="all">All Status</option>
        <option value="running">Running</option>
        <option value="upcoming">Upcoming</option>
        <option value="ended">Ended</option>
      </select>
    </div>
  </div>

  <!-- RESULTS GRID -->
  <div class="election-grid">
    {% for e in elections %}
    <div class="card"
         data-result-card
         data-type="{{ e.election_type }}"
         data-start="{{ e.start_time }}"
         data-end="{{ e.end_time }}">

      <div style="display:flex;align-items:center;gap:8px">
  <b>{{ e.name }}</b>
  <span class="badge {{ 'badge-public' if e.election_type=='public' else 'badge-private' }}">
    {{ e.election_type|upper }}
  </span>
</div>
<div
  class="status-chip"
  data-status-chip
></div>

<div class="vote-pill {{ 'zero' if e.total_votes == 0 }}">
  Total Votes: {{ e.total_votes }}
</div>


      <button class="btn btn-primary"
        onclick="handleResultAccess(
          '{{ e.id }}',
          '{{ e.election_type }}',
          '{{ e.start_time }}',
          '{{ e.end_time }}'
        )">
        Open Results
      </button>

    </div>
    {% endfor %}
  </div>
  <div class="bottom-spacer"></div>

</section>

<!-- ================= PROFILE ================= -->
<section id="profile" class="view-container">
  <div class="card" style="max-width:520px">

    <h3 style="margin-bottom:10px">Admin Profile</h3>

    <!-- NAME -->
    <div class="profile-row">
      <div>
        <div class="profile-label">Name</div>
        <div id="profileName" class="profile-value">{{ admin.name }}</div>
        <input id="profileNameInput" class="profile-input" value="{{ admin.name }}">
      </div>
      <button class="edit-btn" onclick="toggleEdit('Name')">‚úèÔ∏è</button>
    </div>

    <!-- USERNAME -->
    <div class="profile-row">
      <div>
        <div class="profile-label">Username</div>
        <div id="profileUsername" class="profile-value">{{ admin.username }}</div>
        <input id="profileUsernameInput" class="profile-input" value="{{ admin.username }}">
      </div>
      <button class="edit-btn" onclick="toggleEdit('Username')">‚úèÔ∏è</button>
    </div>

    <!-- MOBILE -->
    <div class="profile-row">
      <div>
        <div class="profile-label">Mobile Number</div>
        <div id="profileMobile" class="profile-value">{{ admin.mobile or "Not set" }}</div>
        <input id="profileMobileInput" class="profile-input" value="{{ admin.mobile or '' }}" placeholder="+91xxxxxxxxxx">
      </div>
      <button class="edit-btn" onclick="toggleEdit('Mobile')">‚úèÔ∏è</button>
    </div>

    <!-- WHATSAPP -->
    <div class="profile-row">
      <div>
        <div class="profile-label">WhatsApp Link</div>
        <div id="profileWhatsapp" class="profile-value">
          {{ admin.whatsapp or "Not set" }}
        </div>
        <input id="profileWhatsappInput" class="profile-input" value="{{ admin.whatsapp or '' }}" placeholder="https://wa.me/91xxxxxxxxxx">
      </div>
      <button class="edit-btn" onclick="toggleEdit('Whatsapp')">‚úèÔ∏è</button>
    </div>

    <!-- ADMIN CODE -->
    <div class="profile-row">
      <div>
        <div class="profile-label">Admin Code</div>
        <div class="profile-value">{{ admin.admin_code }}</div>
      </div>
    </div>

<button
  id="saveProfileBtn"
  class="btn btn-primary"
  style="margin-top:14px; display:none"
  onclick="saveProfile()">
  Save Changes
</button>


  </div>
</section>

</main>

<!-- ================= MODALS (ALL REQUIRED) ================= -->

{% raw %}
<!-- CREATE ELECTION -->
<div id="createElectionModal" class="modal">
  <div class="modal-box">
    <h3>Create Election</h3>
    <form method="POST" action="/admin/create-election">
      <input name="name" placeholder="Election name" required>
      <select name="type">
        <option value="public">Public</option>
        <option value="private">Private</option>
      </select>
      <input type="datetime-local" name="start_time">
      <input type="datetime-local" name="end_time">
      <button class="btn btn-primary">Create</button>
      <button class="btn btn-outline" data-no-loading onclick="closeModals()">Cancel</button>

    </form>
  </div>
</div>

<!-- EDIT ELECTION -->
<div id="editElectionModal" class="modal">
  <div class="modal-box">
    <h3>Edit Election</h3>
    <form method="POST" action="/admin/election/update">
      <input type="hidden" id="editElectionId" name="election_id">
      <input id="editElectionName" name="name">
      <input type="datetime-local" id="editElectionStart" name="start_time">
      <input type="datetime-local" id="editElectionEnd" name="end_time">
      <button class="btn btn-primary">Save</button>
      <button type="button" class="btn btn-danger" onclick="confirmDeleteElection()">Delete</button>
      <button type="button" class="btn btn-outline" onclick="confirmForceDeleteElection()">Force Delete</button>
    </form>
  </div>
</div>

<!-- MANAGE CANDIDATES -->
<div id="manageCandidatesModal" class="modal">
  <div class="modal-box">
    <h3 id="mcTitle">Manage Candidates</h3>
    <form method="POST" action="/admin/add-candidate" enctype="multipart/form-data">
      <input type="hidden" id="mcElectionId" name="election_id">
      <input name="name" placeholder="Candidate name" required>
      <input name="party" placeholder="Party">
      <input type="file" name="photo">
      <textarea name="description" placeholder="Description"></textarea>
      <button class="btn btn-primary">Add Candidate</button>
    </form>
    <input id="mcSearchInput" placeholder="Search candidates">
    <div id="mcList"></div>
    <button class="btn btn-outline" onclick="closeModals()">Close</button>
  </div>
</div>

<!-- EDIT CANDIDATE -->
<div id="editCandidateModal" class="modal">
  <div class="modal-box">
    <h3>Edit Candidate</h3>
    <form method="POST" action="/admin/candidate/update" enctype="multipart/form-data">
      <input type="hidden" id="editCandidateId" name="candidate_id">
      <input id="editCandidateName" disabled>
      <input id="editCandidateParty" name="party">
      <textarea id="editCandidateDesc" name="description"></textarea>
      <input type="file" name="photo">
      <button class="btn btn-primary">Save</button>
      <button type="button" class="btn btn-danger" onclick="confirmDeleteCandidate()">Delete</button>
    </form>
  </div>
</div>

<!-- WHITELIST -->
<div id="whitelistModal" class="modal">
  <div class="modal-box">
    <h3 id="wlTitle">Whitelist</h3>
    <form method="POST" action="/admin/whitelist/bulk-add">
      <input type="hidden" id="wlElectionId" name="election_id">
      <textarea name="emails" placeholder="Emails"></textarea>
      <button class="btn btn-primary">Add</button>
    </form>
    <input id="wlSearchInput" placeholder="Search email">
    <div id="wlList"></div>
    <button class="btn btn-outline" onclick="closeModals()">Close</button>
  </div>
</div>
{% endraw %}
<div id="alertModal" class="modal">
  <div class="modal-box" style="max-width:380px;text-align:center">
    <h3 id="alertTitle">Notice</h3>
    <p id="alertMessage" style="margin:14px 0;color:var(--muted)"></p>
    <button class="btn btn-primary" onclick="closeAlert()">OK</button>
  </div>
</div>
<!-- LOGOUT CONFIRMATION -->
<div id="logoutConfirmModal" class="modal">
  <div class="modal-box" style="max-width:360px;text-align:center">
    
    <div style="font-size:36px;margin-bottom:6px">üö™</div>

    <h3 style="margin-bottom:6px">Confirm Logout</h3>

    <p style="color:var(--muted);font-size:14px;line-height:1.5">
      Are you sure you want to log out of the admin panel?
    </p>

    <div style="display:flex;gap:12px;justify-content:center;margin-top:18px">
      <button class="btn btn-outline" onclick="closeLogoutConfirm()">
        Cancel
      </button>
      <button class="btn btn-danger" onclick="confirmLogout()">
        Logout
      </button>
    </div>

  </div>
</div>


<script>
  const VIEW_ORDER = [
  "dashboard",
  "overview",
  "elections",
  "results",
  "profile"
];

function showAlert(message){
  $("#alertMessage").textContent = message;
  $("#alertModal").style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeAlert(){
  $("#alertModal").style.display = "none";
  document.body.style.overflow = "auto";
}

/* ======================================================
   CORE HELPERS
====================================================== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ======================================================
   SPA VIEW SWITCHING
====================================================== */
let currentViewIndex = 0;

function switchView(viewId){
  const views = $$(".view-container");
  const newIndex = VIEW_ORDER.indexOf(viewId);
  if(newIndex === -1) return;

  const direction =
    newIndex > currentViewIndex ? "right" : "left";

  views.forEach(v=>{
    v.classList.remove(
      "active",
      "view-enter-right",
      "view-enter-left"
    );
  });

  const view = document.getElementById(viewId);
  if(!view) return;

  view.classList.add("active");
  view.classList.add(
    direction === "right"
      ? "view-enter-right"
      : "view-enter-left"
  );

  currentViewIndex = newIndex;

  /* Title update */
  const titles = {
    dashboard:"Dashboard",
    overview:"Election Overview",
    elections:"Manage Elections",
    results:"Results",
    profile:"Admin Profile"
  };
  $("#view-title").textContent = titles[viewId] || "Admin Panel";
  updateHeaderActions(viewId);


  /* Sidebar + mobile active states */
  $$(".nav-item").forEach(i=>{
    i.classList.toggle("active", i.textContent.toLowerCase().includes(viewId));
  });
  $$(".m-nav-item").forEach(i=>{
    i.classList.toggle("active", i.dataset.view === viewId);
  });

  localStorage.setItem("admin_active_view", viewId);
  view.scrollTo({ top:0 });
}


/* ======================================================
   MODALS
====================================================== */
function openModal(id){
  const m = document.getElementById(id);
  if(!m) return;
  m.style.display="flex";
  document.body.style.overflow="hidden";
}
function closeModals(){
  $$(".modal").forEach(m=>m.style.display="none");
  document.body.style.overflow="auto";
  localStorage.removeItem("admin_modal"); // ‚úÖ ADD

  document.querySelectorAll(".btn.loading").forEach(btn=>{
    btn.classList.remove("loading");
    btn.disabled = false;
  });
}


window.addEventListener("click",e=>{
  if(e.target.classList.contains("modal")) closeModals();
});
document.addEventListener("keydown", e => {
  if(e.key === "Escape"){
    closeLogoutConfirm();
  }
});


/* ======================================================
   EDIT / DELETE ELECTION
====================================================== */
function openEditElection(id,name,start,end){
  $("#editElectionId").value=id;
  $("#editElectionName").value=name;
  $("#editElectionStart").value=start||"";
  $("#editElectionEnd").value=end||"";
  openModal("editElectionModal");
}
function confirmDeleteElection(){
  const id=$("#editElectionId").value;
  if(id && confirm("Delete election? Only allowed if no votes exist.")){
    location.href=`/admin/election/delete/${id}`;
  }
}
function confirmForceDeleteElection(){
  const id=$("#editElectionId").value;
  if(id && confirm("‚ö† FORCE DELETE will remove election, candidates & votes. Continue?")){
    location.href=`/admin/election/force-delete/${id}`;
  }
}

/* ======================================================
   MANAGE CANDIDATES
====================================================== */
function openManageCandidates(eid, name, start, end){
  $("#mcElectionId").value = eid;
  $("#mcTitle").textContent = "Manage Candidates ‚Äî " + name;

  // Determine election status
  const fakeCard = document.createElement("div");
  fakeCard.dataset.start = start;
  fakeCard.dataset.end = end;
  const isEnded = getElectionStatus(fakeCard) === "ended";

  // Disable ADD CANDIDATE button if ended
  const addBtn = document.querySelector(
    "#manageCandidatesModal form button.btn-primary"
  );
  if(addBtn){
    addBtn.disabled = isEnded;
    addBtn.title = isEnded ? "Election has ended" : "";
  }

  fetch(`/admin/api/candidates/${eid}`)
    .then(r => r.json())
    .then(data => {
      const list = $("#mcList");

      if(!data.candidates.length){
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üë§</div>
            <div class="empty-title">No candidates added</div>
            <div class="empty-text">
              ${isEnded
                ? "This election has ended. Candidates can no longer be modified."
                : "Add candidates to allow voting."}
            </div>
          </div>
        `;
        return;
      }

      list.innerHTML = data.candidates.map(c => `
        <div class="card" style="padding:12px">
          <b>${c.name}</b>
          <div class="note">${c.party || "Independent"}</div>
          <div class="note">Votes: ${c.votes}</div>

          <div style="display:flex;gap:6px;margin-top:6px">
            <button class="btn btn-outline"
              ${isEnded ? "disabled title='Election has ended'" : ""}
              onclick="openEditCandidate(
                '${c.id}',
                '${c.name}',
                '${c.party || ""}',
                '${c.description || ""}'
              )">
              Edit
            </button>

            <button class="btn btn-danger"
              ${isEnded || c.votes > 0 ? "disabled" : ""}
              onclick="
                if(confirm('Delete ${c.name}?')){
                  location.href='/admin/candidate/delete/${c.id}';
                }
              ">
              Delete
            </button>
          </div>
        </div>
      `).join("");
    });

  openModal("manageCandidatesModal");
}

/* ======================================================
   EDIT CANDIDATE
====================================================== */
function openEditCandidate(id,name,party,desc){
  $("#editCandidateId").value=id;
  $("#editCandidateName").value=name;
  $("#editCandidateParty").value=party||"";
  $("#editCandidateDesc").value=desc||"";
  openModal("editCandidateModal");
}
function confirmDeleteCandidate(){
  const id=$("#editCandidateId").value;
  if(id && confirm("Delete candidate? Only allowed if zero votes.")){
    location.href=`/admin/candidate/delete/${id}`;
  }
}

/* ======================================================
   WHITELIST
====================================================== */
function openWhitelist(eid, name, start, end){
  $("#wlElectionId").value = eid;
  $("#wlTitle").textContent = "Whitelist ‚Äî " + name;

  // Determine election status
  const fakeCard = document.createElement("div");
  fakeCard.dataset.start = start;
  fakeCard.dataset.end = end;
  const isEnded = getElectionStatus(fakeCard) === "ended";

  // Disable ADD button if ended
  const addBtn = document.querySelector(
    "#whitelistModal form button.btn-primary"
  );
  if(addBtn){
    addBtn.disabled = isEnded;
    addBtn.title = isEnded ? "Election has ended" : "";
  }

  fetch(`/admin/api/whitelist/${eid}`)
    .then(r => r.json())
    .then(data => {
      const list = $("#wlList");

      if(!data.whitelist.length){
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìß</div>
            <div class="empty-title">Whitelist is empty</div>
            <div class="empty-text">
              Only whitelisted voters can participate in this private election.
              ${isEnded ? "This election has ended." : "Add voter emails to enable access."}
            </div>
          </div>
        `;
        return;
      }

      list.innerHTML = data.whitelist
        .sort((a,b)=>a.email.localeCompare(b.email))
        .map(w => `
          <div class="card" style="padding:10px">
            <b>${w.email}</b>
            <button class="btn btn-danger"
              ${isEnded ? "disabled title='Election has ended'" : ""}
              onclick="
                if(confirm('Remove ${w.email}?')){
                  location.href='/admin/whitelist/remove/${w.id}';
                }
              ">
              Remove
            </button>
          </div>
        `).join("");
    });

  openModal("whitelistModal");
}


/* ======================================================
   SEARCH FILTERS
====================================================== */
function attachCandidateSearch(){
  const input = document.getElementById("mcSearchInput");
  const list  = document.getElementById("mcList");
  if(!input || !list) return;

  input.addEventListener("input", () => {
    const q = input.value.toLowerCase();
    list.querySelectorAll(".card").forEach(card => {
      const name = card.querySelector("b")?.innerText.toLowerCase() || "";
      card.style.display = name.includes(q) ? "" : "none";
    });
  });
}
function attachWhitelistSearch(){
  const input = document.getElementById("wlSearchInput");
  const list  = document.getElementById("wlList");
  if(!input || !list) return;

  input.addEventListener("input", () => {
    const q = input.value.toLowerCase();
    list.querySelectorAll(".card").forEach(card => {
      const email = card.querySelector("b")?.innerText.toLowerCase() || "";
      card.style.display = email.includes(q) ? "" : "none";
    });
  });
}
attachCandidateSearch();
attachWhitelistSearch();


/* Overview search */
$("#ovPublicSearch")?.addEventListener("input",e=>{
  const q=e.target.value.toLowerCase();
  $$("[data-ov-card]").forEach(c=>{
    if(c.dataset.type!=="public") return;
    c.style.display=(c.dataset.name.includes(q)||c.dataset.code.includes(q))?"":"none";
  });
});
$("#ovPrivateSearch")?.addEventListener("input",e=>{
  const q=e.target.value.toLowerCase();
  $$("[data-ov-card]").forEach(c=>{
    if(c.dataset.type!=="private") return;
    c.style.display=c.dataset.name.includes(q)?"":"none";
  });
});

/* ======================================================
   COUNTDOWN ENGINE (SINGLE INTERVAL)
====================================================== */
function format(ms){
  if(ms<=0) return "00:00:00";
  const s=Math.floor(ms/1000);
  return [
    Math.floor(s/3600),
    Math.floor((s%3600)/60),
    s%60
  ].map(v=>String(v).padStart(2,"0")).join(":");
}

function updateCountdowns(){
  const now=Date.now();

  $$("[data-election-card]").forEach(card=>{
    const start=card.dataset.start?Date.parse(card.dataset.start):null;
    const end=card.dataset.end?Date.parse(card.dataset.end):null;
    const note=card.querySelector(".election-state-note");
    const timer=card.querySelector(".countdown-timer");

    if(!start&&!end){
      note.textContent="No schedule set";
      timer.textContent="";
      return;
    }
    if(start&&now<start){
      note.textContent="Election not started";
      timer.textContent="Starts in: "+format(start-now);
      return;
    }
    if(end&&now<end){
      note.textContent="Election running";
      timer.textContent="Ends in: "+format(end-now);
      return;
    }
    note.textContent="Election ended";
    timer.textContent="Ended";
  });

  $$("[data-ov-card]").forEach(card=>{
    const start=card.dataset.start?Date.parse(card.dataset.start):null;
    const end=card.dataset.end?Date.parse(card.dataset.end):null;
    const timer=card.querySelector(".countdown-timer");
    if(!timer) return;
    if(start&&now<start) timer.textContent="Starts in: "+format(start-now);
    else if(end&&now<end) timer.textContent="Ends in: "+format(end-now);
    else timer.textContent="Ended";
  });
  updateStatusChips();

}

let timer=null;
function startCountdown(){
  if(timer) return;
  updateCountdowns();
  timer=setInterval(updateCountdowns,1000);
}
document.addEventListener("visibilitychange",()=>{
  document.hidden?clearInterval(timer):startCountdown();
});
startCountdown();
/* ======================================================
   STATUS RESOLVER (single source of truth)
====================================================== */
function getElectionStatus(card){
  const now = Date.now();
  const start = card.dataset.start ? Date.parse(card.dataset.start) : null;
  const end   = card.dataset.end   ? Date.parse(card.dataset.end)   : null;

  if(start && now < start) return "upcoming";
  if(end && now > end) return "ended";
  if(start && end && now >= start && now <= end) return "running";
  return "unknown";
}

/* ======================================================
   ELECTIONS FILTER
====================================================== */
function applyElectionFilters(){
  const q = $("#electionSearch")?.value.toLowerCase() || "";
  const type = $("#electionTypeFilter")?.value || "all";
  const status = $("#electionStatusFilter")?.value || "all";

  $$("[data-election-card]").forEach(card=>{
    const name = card.querySelector("h3")?.innerText.toLowerCase() || "";
    const eType = card.dataset.type;
    const eStatus = getElectionStatus(card);

    const match =
      name.includes(q) &&
      (type === "all" || eType === type) &&
      (status === "all" || eStatus === status);

    card.style.display = match ? "" : "none";
  });
}

["electionSearch","electionTypeFilter","electionStatusFilter"]
  .forEach(id=>$("#"+id)?.addEventListener("input",applyElectionFilters));
/* ======================================================
   OVERVIEW FILTER
====================================================== */
function applyResultsFilters(){
  const q = $("#resultsSearch")?.value.toLowerCase() || "";
  const type = $("#resultsTypeFilter")?.value || "all";
  const status = $("#resultsStatusFilter")?.value || "all";

  $$("[data-result-card]").forEach(card => {
    const name = card.querySelector("b")?.innerText.toLowerCase() || "";
    const eType = card.dataset.type;
    const eStatus = getElectionStatus(card);

    const match =
      name.includes(q) &&
      (type === "all" || eType === type) &&
      (status === "all" || eStatus === status);

    card.style.display = match ? "" : "none";
  });
}

["resultsSearch","resultsTypeFilter","resultsStatusFilter"]
  .forEach(id => $("#"+id)?.addEventListener("input", applyResultsFilters));

function applyOverviewFilters(){
  const q = $("#overviewSearch")?.value.toLowerCase() || "";
  const type = $("#overviewTypeFilter")?.value || "all";
  const status = $("#overviewStatusFilter")?.value || "all";

  $$("[data-ov-card]").forEach(card=>{
    const name = card.dataset.name || "";
    const eType = card.dataset.type || "";
    const eStatus = getElectionStatus(card);

    const match =
      name.includes(q) &&
      (type === "all" || eType === type) &&
      (status === "all" || eStatus === status);

    card.style.display = match ? "" : "none";
  });
}

["overviewSearch","overviewTypeFilter","overviewStatusFilter"]
  .forEach(id=>$("#"+id)?.addEventListener("input",applyOverviewFilters));
/* ======================================================
   MOBILE NAV AUTO-HIDE ON SCROLL
====================================================== */
(function(){
  const nav = document.querySelector(".mobile-nav");
  if(!nav) return;

  let lastY = 0;
  let ticking = false;

  function attachScroll(container){
    if(!container) return;

    lastY = container.scrollTop;

    container.addEventListener("scroll", () => {
      if(!ticking){
        window.requestAnimationFrame(() => {
          const currentY = container.scrollTop;
          const delta = currentY - lastY;

          if(Math.abs(delta) > 6){
            if(delta > 0){
              nav.classList.add("hidden");   // scrolling down
            }else{
              nav.classList.remove("hidden"); // scrolling up
            }
            lastY = currentY;
          }

          ticking = false;
        });
        ticking = true;
      }
    }, { passive:true });
  }

  // attach to active view
  function bindActiveView(){
    const active = document.querySelector(".view-container.active");
    if(active){
      attachScroll(active);
    }
  }

  // initial bind
  bindActiveView();

  // rebind on view change
  const _switchView = window.switchView;
  window.switchView = function(viewId){
    _switchView(viewId);
    setTimeout(bindActiveView, 50);
  };
})();

/* ======================================================
   BUTTON LOADING HANDLER
====================================================== */
function enableButtonLoading(){
  document.querySelectorAll("form").forEach(form=>{
    form.addEventListener("submit",e=>{
      const btn = form.querySelector("button[type='submit'], .btn-primary");
      if(!btn) return;

      btn.classList.add("loading");
      btn.disabled = true;
    });
  });

  document.querySelectorAll(".btn").forEach(btn=>{
    if(btn.type === "submit") return;

    btn.addEventListener("click",()=>{
      if(btn.dataset.noLoading) return;
      btn.classList.add("loading");
    });
  });
}

enableButtonLoading();

/* ======================================================
   RESTORE LAST VIEW ON REFRESH
====================================================== */
document.addEventListener("DOMContentLoaded", () => {
  const modalStateRaw = localStorage.getItem("admin_modal");
  const savedView = localStorage.getItem("admin_active_view");

  // 1Ô∏è‚É£ Modal restoration has TOP priority
  if (modalStateRaw) {
    const { type, electionId, electionName } = JSON.parse(modalStateRaw);

    currentViewIndex = VIEW_ORDER.indexOf("elections");
    switchView("elections");

    // wait for view animation/layout
    setTimeout(() => {
      if (type === "candidates") {
        openManageCandidates(electionId, electionName);
      }
      if (type === "whitelist") {
        openWhitelist(electionId, electionName);
      }
    }, 200);

    return; // ‚õî STOP further view logic
  }

  // 2Ô∏è‚É£ Restore last active view
  if (savedView && VIEW_ORDER.includes(savedView)) {
    currentViewIndex = VIEW_ORDER.indexOf(savedView);
    switchView(savedView);
    return;
  }

  // 3Ô∏è‚É£ Final fallback
  currentViewIndex = 0;
  switchView("dashboard");
});

function rememberModal(type, electionId, electionName){
  localStorage.setItem("admin_modal", JSON.stringify({
    type,
    electionId,
    electionName
  }));
}
function handleResultAccess(id, type, start, end){
  const fakeCard = document.createElement("div");
  fakeCard.dataset.start = start;
  fakeCard.dataset.end = end;

  const status = getElectionStatus(fakeCard);

  // üîí Private election ‚Üí only AFTER end
  if(type === "private" && status !== "ended"){
    showAlert("This private election is not finished yet.");
    return;
  }

  // ‚è≥ Public election ‚Üí only AFTER start
  if(type === "public" && status === "upcoming"){
    showAlert("This public election has not started yet.");
    return;
  }

  // ‚úÖ Allowed
  window.location.href = `/admin/results/${id}`;
}
function updateHeaderActions(viewId){
  const actions = document.getElementById("header-actions");
  if(!actions) return;

  // reset
  actions.innerHTML = "";

  // Dashboard / Elections ‚Üí New Election
  if(viewId === "dashboard" || viewId === "elections" || viewId === "overview"){
    actions.innerHTML = `
      <button class="btn btn-primary"
        onclick="openModal('createElectionModal')">
        + New Election
      </button>
    `;
  }
  if(viewId === "profile"){
    actions.innerHTML = `
<button class="btn btn-danger" onclick="openLogoutConfirm()">
  Logout
</button>



    `;
  }
  // Results ‚Üí View All Results
  if(viewId === "results"){
    actions.innerHTML = `
      <a href="/admin/results">
        <button class="btn btn-primary">
          View All Results
        </button>
      </a>
    `;
  }
}
function toggleEdit(field){
  const input = document.getElementById("profile" + field + "Input");
  if(!input) return;

  // Always show input (no toggle back)
  input.style.display = "block";

  // Show Save button when ANY edit happens
  const saveBtn = document.getElementById("saveProfileBtn");
  if(saveBtn) saveBtn.style.display = "inline-flex";
}


let lastProfileDraft = null;

function saveProfile(){
  const nameEl = document.getElementById("profileNameInput");
  const userEl = document.getElementById("profileUsernameInput");
  const mobEl  = document.getElementById("profileMobileInput");
  const waEl   = document.getElementById("profileWhatsappInput");
  const saveBtn = document.getElementById("saveProfileBtn");

  if(!nameEl || !userEl || !mobEl || !waEl){
    showAlert("Profile inputs not found");
    return;
  }

  const name = nameEl.value.trim();
  const username = userEl.value.trim();
  const mobile = mobEl.value.trim();
  const whatsapp = waEl.value.trim();

  // Save draft BEFORE request
  lastProfileDraft = { name, username, mobile, whatsapp };

  fetch("/admin/profile/update",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(lastProfileDraft)
  })
  .then(r => r.json())
  .then(res => {

    /* ‚ùå FAILURE */
    if(!res.success){
      showAlert(res.message || "Profile update failed");
      restoreProfileDraft();

      // Keep inputs visible
      ["Name","Username","Mobile","Whatsapp"].forEach(f=>{
        const i = document.getElementById("profile"+f+"Input");
        if(i) i.style.display = "block";
      });

      // Keep Save button visible
      if(saveBtn) saveBtn.style.display = "inline-flex";
      return;
    }

    /* ‚úÖ SUCCESS */
    document.getElementById("profileName").textContent = name;
    document.getElementById("profileUsername").textContent = username;
    document.getElementById("profileMobile").textContent = mobile || "Not set";
    document.getElementById("profileWhatsapp").textContent = whatsapp || "Not set";

    // Hide inputs
    ["Name","Username","Mobile","Whatsapp"].forEach(f=>{
      const i = document.getElementById("profile"+f+"Input");
      if(i) i.style.display = "none";
    });

    // Hide Save button
    if(saveBtn) saveBtn.style.display = "none";

    showAlert("Profile updated successfully");
  })
  .catch(err=>{
    console.error(err);
    showAlert("Network error while saving profile");
    restoreProfileDraft();

    if(saveBtn) saveBtn.style.display = "inline-flex";
  });
}

function restoreProfileDraft(){
  if(!lastProfileDraft) return;

  const nameEl = document.getElementById("profileNameInput");
  const userEl = document.getElementById("profileUsernameInput");
  const mobEl  = document.getElementById("profileMobileInput");
  const waEl   = document.getElementById("profileWhatsappInput");

  if(nameEl) nameEl.value = lastProfileDraft.name;
  if(userEl) userEl.value = lastProfileDraft.username;
  if(mobEl)  mobEl.value  = lastProfileDraft.mobile;
  if(waEl)   waEl.value   = lastProfileDraft.whatsapp;
}
function handleDashboardAlert(action, id, name, start, end){
  // Always go to elections view first
  currentViewIndex = VIEW_ORDER.indexOf("elections");
  switchView("elections");

  setTimeout(() => {
    if(action === "candidates"){
      rememberModal("candidates", id, name);
      openManageCandidates(id, name, start, end);
    }

    if(action === "whitelist"){
      rememberModal("whitelist", id, name);
      openWhitelist(id, name, start, end);
    }

    if(action === "scroll"){
      const card = document.querySelector(
        `[data-election-card][onclick*="'${id}'"]`
      );
      if(card){
        card.scrollIntoView({ behavior:"smooth", block:"center" });
        card.style.boxShadow = "0 0 0 2px var(--yellow)";
        setTimeout(()=>card.style.boxShadow="",1200);
      }
    }
  }, 250);
}
/* ======================================================
   STATUS CHIP ENGINE (AUTO-UPDATE)
====================================================== */
function updateStatusChips(){
  $$("[data-status-chip]").forEach(chip=>{
    const card = chip.closest("[data-start]");
    if(!card) return;

    const status = getElectionStatus(card);

    chip.className = "status-chip"; // reset

    if(status === "upcoming"){
      chip.textContent = "UPCOMING";
      chip.classList.add("status-upcoming");
    }
    else if(status === "running"){
      chip.textContent = "RUNNING";
      chip.classList.add("status-running");
    }
    else if(status === "ended"){
      chip.textContent = "ENDED";
      chip.classList.add("status-ended");
    }
  });
}
function openLogoutConfirm(){
  const m = document.getElementById("logoutConfirmModal");
  if(!m) return;

  m.style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeLogoutConfirm(){
  const m = document.getElementById("logoutConfirmModal");
  if(!m) return;

  m.style.display = "none";
  document.body.style.overflow = "auto";
}

function confirmLogout(){
  localStorage.removeItem("admin_active_view");
  localStorage.removeItem("admin_modal");
  window.location.href = "/logout";
}

</script>

</body>
</html>
