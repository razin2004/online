<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/svg+xml" href="/static/uploads/votecentral-icon.svg">
<meta charset="UTF-8" />
<title>VoteCentral â€” Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ======================================================
   PREMIUM ADMIN DASHBOARD UI
   Compatible with existing HTML & JS
====================================================== */

/* ======================================================
   DESIGN TOKENS
====================================================== */
:root{
  --bg-dark:#020617;
  --bg-panel:#020617;
  --sidebar-bg:#0b1220;
  --card-bg:rgba(30,41,59,.72);
  --card-bg-hover:rgba(30,41,59,.88);
  --border:rgba(148,163,184,.12);
  --brand-blue:#2563eb;
  --blue:var(--brand-blue);

  --indigo:#6366f1;
  --green:#10b981;
  --red:#ef4444;
  --yellow:#f59e0b;

  --text:#f8fafc;
  --muted:#94a3b8;
  --muted-soft:#64748b;

  --radius-xl:20px;
  --radius-lg:16px;
  --radius-md:12px;

  --shadow-soft:0 10px 30px rgba(0,0,0,.25);
  --shadow-hover:0 20px 60px rgba(0,0,0,.45);

  --blur:blur(14px);
  --mobile-nav-height: 70px;
  --bottom-safe-gap: 50px;
}
input,
select,
textarea{
  min-width:0;       /* ðŸ”‘ prevents grid overflow */
  max-width:100%;
}

/* ======================================================
   RESET & BASE
====================================================== */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Plus Jakarta Sans",system-ui,sans-serif;
}

html,body{
  height:100%;
  overflow-x: hidden;
}

body{
  background:
    radial-gradient(1200px 600px at 80% -10%,rgba(56,189,248,.08),transparent),
    linear-gradient(180deg,#020617,#020617);
  color:var(--text);
  display:flex;
  overflow-x:hidden;   /* âœ… allow vertical scroll */
  overflow-y:auto;
  -webkit-font-smoothing:antialiased;
}
@media (max-width:768px){
  body{
    overflow: hidden;
  }
}

/* ======================================================
   SCROLLBAR (GLOBAL)
====================================================== */
*::-webkit-scrollbar{
  width:8px;
}
*::-webkit-scrollbar-thumb{
  background:rgba(148,163,184,.25);
  border-radius:20px;
}
*::-webkit-scrollbar-track{
  background:transparent;
}

/* ======================================================
   SIDEBAR
====================================================== */
.sidebar{
  width:260px;
  background:linear-gradient(180deg,#020617,#0b1220);
  border-right:1px solid var(--border);
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

.sidebar-brand{
  font-size:20px;
  font-weight:800;
  letter-spacing:.4px;
  background:linear-gradient(90deg,var(--blue),var(--indigo));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:6px;
}

.nav-menu{
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.nav-item{
  padding:12px 16px;
  border-radius:14px;
  cursor:pointer;
  color:var(--muted);
  font-weight:600;
  display:flex;
  align-items:center;
  gap:12px;
  transition:.25s ease;
}

.nav-item:hover{
  background:rgba(56,189,248,.08);
  color:var(--text);
}

.nav-item.active{
  background:linear-gradient(90deg,rgba(56,189,248,.18),transparent);
  color:var(--blue);
  box-shadow:inset 0 0 0 1px rgba(56,189,248,.25);
}

.sidebar-footer{
  margin-top:auto;
}

/* ======================================================
   MAIN WRAPPER
====================================================== */
.main-wrapper{
  flex:1;
  display:flex;
  flex-direction:column;
  min-height:100vh;   /* âœ… SAFE */
}

@media(max-width:768px){
  .sidebar{display:none}
  .mobile-nav{display:flex}
  .top-header{padding:0 16px}
}
@media (max-width:768px){
/* Bottom scroll spacer */
.bottom-spacer{
  height: calc(
    var(--mobile-nav-height)
    + env(safe-area-inset-bottom)
    + 45px
  );
  flex-shrink: 0;
}

}
@media (max-width:768px){
  .view-container{
    padding:14px;
    padding-bottom:14px; /* ðŸ”‘ NORMAL padding only */
  }
}

@media (max-width: 768px){
  .modal-box{
    margin-bottom: calc(
      var(--mobile-nav-height)
      + env(safe-area-inset-bottom)
    
    );
  }
}
.modal-box{
  position:relative;
}

/* ======================================================
   TOP HEADER
====================================================== */
.top-header{
  height:72px;
  padding:0 28px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(2,6,23,.75);
  backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  z-index:50;
}

#view-title{
  font-size:18px;
  font-weight:700;
  letter-spacing:.3px;
}

/* ======================================================
   VIEW CONTAINERS
====================================================== */
.view-container{
  flex:1;
  padding:26px;
  overflow-y:auto;
  display:none;
  animation:fadeUp .35s ease;
}

.view-container.active{
  display:block;
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:translateY(0)}
}

/* ======================================================
   CARDS
====================================================== */
.card{
  background:linear-gradient(180deg,var(--card-bg),rgba(2,6,23,.85));
  border:1px solid var(--border);
  border-radius:var(--radius-xl);
  padding:20px;
  margin-bottom:18px;
  backdrop-filter:var(--blur);
  box-shadow:var(--shadow-soft);
  transition:.3s ease;
}

.card:hover{
  background:linear-gradient(180deg,var(--card-bg-hover),rgba(2,6,23,.9));
  box-shadow:var(--shadow-hover);
  transform:translateY(-2px);
}

/* ======================================================
   GRIDS
====================================================== */
.stat-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:18px;
}

.election-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:18px;
}

/* ======================================================
   TYPOGRAPHY INSIDE CARDS
====================================================== */
.card h1{
  font-size:32px;
  font-weight:800;
  margin-top:6px;
}

.card h3{
  font-size:16px;
  font-weight:700;
}

.card b{
  font-weight:700;
}

.card small{
  color:var(--muted);
  font-weight:600;
}

/* ======================================================
   BUTTONS
====================================================== */
.btn{
  padding:10px 18px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:700;
  letter-spacing:.2px;
  transition:.25s ease;
}

.btn-primary{
  background:linear-gradient(135deg,var(--blue),var(--indigo));
  color:#020617;
}

.btn-primary:hover{
  filter:brightness(1.1);
}

.btn-outline{
  background:rgba(255,255,255,.04);
  border:1px solid var(--border);
  color:var(--text);
}

.btn-outline:hover{
  background:rgba(255,255,255,.08);
}

.btn-danger{
  background:rgba(239,68,68,.15);
  color:var(--red);
  border:1px solid rgba(239,68,68,.35);
}

/* ======================================================
   BADGES
====================================================== */
.badge{
  padding:5px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  letter-spacing:.4px;
}

.badge-public{
  background:rgba(16,185,129,.18);
  color:#34d399;
}

.badge-private{
  background:rgba(99,102,241,.18);
  color:#818cf8;
}

/* ======================================================
   INPUTS & SELECTS
====================================================== */
input,select,textarea{
  width:100%;
  padding:11px 12px;
  border-radius:12px;
  background:rgba(2,6,23,.85);
  border:1px solid var(--border);
  color:var(--text);
  outline:none;
  transition:.25s ease;
}

input::placeholder{
  color:var(--muted-soft);
}

input:focus,select:focus,textarea:focus{
  border-color:var(--blue);
  box-shadow:0 0 0 2px rgba(56,189,248,.25);
}
/* ================= TOAST SYSTEM ================= */

#toastContainer{
  position:fixed;
  top:88px;              /* below sticky header */
  right:24px;
  display:flex;
  flex-direction:column;
  gap:14px;
  z-index:4000;
  pointer-events:none;
}

/* Mobile */
@media(max-width:600px){
  #toastContainer{
    left:16px;
    right:16px;
    top:88px;
    align-items:center;
  }
}
.toast{
  min-width:320px;
  max-width:420px;
  padding:16px 18px;
  border-radius:16px;

  background:rgba(15,23,42,.75);   /* semi transparent */
  backdrop-filter:blur(14px);      /* ðŸ”¥ actual blur */
  -webkit-backdrop-filter:blur(14px);

  border:1px solid var(--border);
  box-shadow:0 20px 60px rgba(0,0,0,.45);

  display:flex;
  align-items:flex-start;
  gap:12px;

  font-size:.85rem;
  font-weight:600;

  animation:toastIn .25s ease-out;
  pointer-events:auto;
}


/* Mobile width */
@media(max-width:600px){
  .toast{
    width:100%;
    max-width:100%;
  }
}

.toast-success{
  border-left:4px solid var(--green);
}

.toast-error{
  border-left:4px solid var(--red);
}

.toast-warning{
  border-left:4px solid var(--yellow);
}

.toast-icon{
  width:22px;
  height:22px;
  flex-shrink:0;
}

.toast-close{
  margin-left:auto;
  cursor:pointer;
  opacity:.6;
}

.toast-close:hover{
  opacity:1;
}

@keyframes toastIn{
  from{opacity:0;transform:translateY(-8px);}
  to{opacity:1;transform:translateY(0);}
}

/* ======================================================
   MOBILE NAV
====================================================== */

.mobile-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height: var(--mobile-nav-height);
  background:rgba(2,6,23,.9);
  backdrop-filter:blur(18px);
  border-top:1px solid var(--border);
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1000;
}


.m-nav-item{
  color:var(--muted);
  font-size:11px;
  font-weight:600;
  text-align:center;
  transition:.25s ease;
}

.m-nav-item.active{
  color:var(--blue);
  transform:translateY(-2px);
}

/* ======================================================
   MODALS
====================================================== */
/* ======================================================
   PREMIUM MODAL SYSTEM
====================================================== */

.modal{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,.75);
  backdrop-filter:blur(10px);
  z-index:12000;
  padding:20px;
}

.modal-box{
  width:520px;
  max-width:95%;
  background:linear-gradient(180deg,#0b1220,#020617);
  border:1px solid var(--border);
  border-radius:22px;
  box-shadow:0 60px 140px rgba(0,0,0,.8);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  animation:fadeUp .25s ease;
}

/* HEADER */
.modal-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:18px 22px;
  border-bottom:1px solid var(--border);
}

.modal-title{
  font-size:16px;
  font-weight:800;
  letter-spacing:.3px;
}

/* BODY */
.modal-body{
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:16px;
  overflow-y:auto;
  max-height:65vh;
}

/* FOOTER */
.modal-footer{
  padding:16px 4px;
  border-top:1px solid var(--border);
  display:flex;
  justify-content: flex-start;
  gap:10px;
}

/* FORM GRID */
.modal-form{
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* INPUT GROUP */
.form-group{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.form-label{
  font-size:12px;
  font-weight:700;
  color:var(--muted);
  letter-spacing:.3px;
}

/* Close button */
.modal-close{
  background:rgba(255,255,255,.05);
  border:1px solid var(--border);
  border-radius:10px;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:.2s ease;
}

.modal-close:hover{
  background:rgba(239,68,68,.15);
  border-color:rgba(239,68,68,.4);
  color:var(--red);
}

/* Mobile */
@media(max-width:768px){
  .modal-box{
    width:100%;
    border-radius:20px;
    max-height:85vh;
  }
}


/* ======================================================
   RESPONSIVE
====================================================== */
.mobile-nav{
  display:none;
}

@media(max-width:768px){
  .sidebar{display:none}
  .mobile-nav{display:flex}
  .top-header{padding:0 16px}
}
/* Auto-hide animation for mobile nav */
.mobile-nav{
  transition: transform .35s ease, opacity .35s ease;
  will-change: transform, opacity;
}

.mobile-nav.hidden{
  transform: translateY(110%);
  opacity: 0;
}
/* ======================================================
   EMPTY STATES
====================================================== */
/* ======================================================
   PREMIUM EMPTY STATE SYSTEM
====================================================== */
.empty-card{
  background:linear-gradient(
    180deg,
    rgba(30,41,59,.65),
    rgba(2,6,23,.95)
  );
  border:1px solid var(--border);
  border-radius:var(--radius-xl);
  padding:60px 40px;
  text-align:center;
  box-shadow:var(--shadow-soft);
  animation:fadeUp .35s ease;
}

.empty-icon{
  width:90px;
  height:90px;
  margin:0 auto 22px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,var(--blue),var(--indigo));
  color:#020617;
  box-shadow:0 20px 60px rgba(37,99,235,.25);
}

.empty-icon svg{
  width:38px;
  height:38px;
}

.empty-title{
  font-size:18px;
  font-weight:800;
  margin-bottom:8px;
  letter-spacing:.3px;
}

.empty-text{
  font-size:14px;
  color:var(--muted);
  max-width:520px;
  margin:0 auto 12px;
  line-height:1.6;
}

.empty-meta{
  font-size:12px;
  color:var(--muted-soft);
  opacity:.8;
}

.empty-action{
  margin-top:16px;
}

@media(max-width:768px){
  .empty-state{
    padding:36px 18px;
  }
  .empty-text{
    font-size:12.5px;
  }
}
.m-nav-item.active{
  color:var(--blue);
  transform:translateY(-1px);
}

/* ======================================================
   DIRECTIONAL VIEW TRANSITIONS
====================================================== */
.view-container{
  position:relative;
}

.view-enter-right{
  animation:slideInRight .35s ease forwards;
}

.view-enter-left{
  animation:slideInLeft .35s ease forwards;
}

@keyframes slideInRight{
  from{opacity:0; transform:translateX(24px)}
  to{opacity:1; transform:translateX(0)}
}

@keyframes slideInLeft{
  from{opacity:0; transform:translateX(-24px)}
  to{opacity:1; transform:translateX(0)}
}
/* ======================================================
   BUTTON LOADING STATES
====================================================== */
.btn{
  position:relative;
}

.btn.loading{
  pointer-events:none;
  opacity:.7;
}

.btn.loading::after{
  content:"";
  width:16px;
  height:16px;
  border:2px solid rgba(255,255,255,.4);
  border-top-color:#fff;
  border-radius:50%;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  animation:spin .8s linear infinite;
}

@keyframes spin{
  to{ transform:translate(-50%,-50%) rotate(360deg) }
}
.btn-danger.loading::after{
  border-top-color:var(--red);
}
/* ======================================================
   DISABLED BUTTON STATES (GLOBAL)
====================================================== */
.btn:disabled,
.btn[disabled]{
  cursor:not-allowed;
  opacity:.45;
  filter:grayscale(.6);
  box-shadow:none !important;
  transform:none !important;
}

/* Prevent hover / active effects */
.btn:disabled:hover{
  background:inherit;
  filter:grayscale(.6);
}

/* Primary disabled */
.btn-primary:disabled{
  background:linear-gradient(135deg,#475569,#64748b);
  color:#e5e7eb;
}

/* Outline disabled */
.btn-outline:disabled{
  background:rgba(255,255,255,.03);
  color:var(--muted);
  border-color:rgba(148,163,184,.2);
}

/* Danger disabled */
.btn-danger:disabled{
  background:rgba(239,68,68,.12);
  color:#fca5a5;
  border-color:rgba(239,68,68,.25);
}

/* Tooltip-style hint (uses title attribute) */
.btn:disabled[title]{
  position:relative;
}

.btn:disabled[title]:hover::after{
  content:attr(title);
  position:absolute;
  bottom:110%;
  left:50%;
  transform:translateX(-50%);
  background:rgba(15,23,42,.95);
  color:#f8fafc;
  font-size:11px;
  font-weight:600;
  padding:6px 10px;
  border-radius:8px;
  white-space:nowrap;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
  pointer-events:none;
  opacity:1;
  z-index:999;
}

.btn:disabled[title]:hover::before{
  content:"";
  position:absolute;
  bottom:100%;
  left:50%;
  transform:translateX(-50%);
  border:6px solid transparent;
  border-top-color:rgba(15,23,42,.95);
}
.profile-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 0;
  border-bottom:1px dashed var(--border);
}

.profile-row:last-child{
  border-bottom:none;
}

.profile-label{
  color:var(--muted);
  font-size:13px;
}

.profile-value{
  font-weight:600;
}

.edit-btn{
  background:none;
  border:none;
  cursor:pointer;
  color:var(--blue);
  font-size:14px;
}

.profile-input{
  display:none;
  margin-top:6px;
}
.stat-breakdown{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}

.chip{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
  letter-spacing:.3px;
}

.chip-public{
  background:rgba(16,185,129,.18);
  color:#34d399;
}

.chip-private{
  background:rgba(99,102,241,.18);
  color:#818cf8;
}

.chip-running{
  background:rgba(16,185,129,.18);
  color:#34d399;
}

.chip-upcoming{
  background:rgba(245,158,11,.18);
  color:#fbbf24;
}

.chip-ended{
  background:rgba(239,68,68,.18);
  color:#f87171;
}
/* ======================================================
   DASHBOARD ALERT SEVERITY
====================================================== */
.alert-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
  transition:.25s ease;
}

.alert-item:hover{
  background:rgba(255,255,255,.05);
}

.alert-icon{
  font-size:18px;
}

.alert-text{
  font-size:14px;
  font-weight:600;
}

.alert-critical{
  color:#f87171;
}

.alert-warning{
  color:#fbbf24;
}

.alert-info{
  color:#60a5fa;
}
/* EXTRA-STRONG election name inside alerts */
.alert-text b{
  font-weight:800;
  color:inherit;       /* same color as parent */
  text-shadow:none;
}
.alert-critical .alert-text b{
  color:#e54343;
}

.alert-warning .alert-text b{
  color:#ba8601;
}

.alert-info .alert-text b{
  color:#246ac1;
}

@media (max-width: 768px){

  :root{
    --radius-xl:16px;
    --radius-lg:14px;
    --radius-md:10px;
  }
}

@media (max-width: 768px){

  .card{
    padding:14px;
    margin-bottom:12px;
  }

  .stat-grid,
  .election-grid{
    gap:12px;
  }
}
@media (max-width: 768px){

  .card h1{
    font-size:22px;
  }

  .card h3{
    font-size:14px;
  }

  .card b{
    font-size:14px;
  }

  .card small{
    font-size:11px;
  }

  .alert-text{
    font-size:13px;
  }

  .empty-title{
    font-size:14px;
  }

  .empty-text{
    font-size:12px;
  }
}
@media (max-width: 768px){

  .btn{
    padding:8px 14px;
    font-size:12px;
    border-radius:10px;
  }

  .btn-primary,
  .btn-outline,
  .btn-danger{
    font-weight:600;
  }
}
@media (max-width: 768px){

  .top-header{
    height:70px;
    padding:0 14px;
    position:sticky;
    top:0;
    isolation:isolate; 
  }

  #view-title{
    font-size:15px;
  }

  .mobile-nav{
    height:58px;
  }

  .m-nav-item{
    font-size:10px;
  }
}
/* ================= MOBILE TITLE LOGO (SAFE) ================= */

.header-title-group{
  display:flex;
  flex-direction:column;
  align-items:flex-start; /* ðŸ”‘ left aligned */
}

/* hidden by default */
.mobile-title-logo{
  display:none;
}

/* mobile only */
@media (max-width:768px){
  .mobile-title-logo{
    display:block;
    height:35px;
    margin-bottom:-5px; /* tiny gap above title */
    margin-left: -4px;
  }
}

@media (max-width: 768px){

  .election-grid{
    grid-template-columns:1fr;
  }

  .stat-grid{
    grid-template-columns:1fr 1fr;
  }
}
@media (max-width: 768px){

  .card{
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }

  .card:hover{
    transform:none;
  }
}
@media (max-width: 768px){
  .modal{
    align-items:center;     /* âœ… center vertically */
    justify-content:center; /* âœ… center horizontally */
  }
}
@media (max-width: 768px){
  .modal-box{
    width:92%;
    max-width:420px;
    border-radius:18px;
    padding:16px;
    max-height:78vh;
  }
}

@media (max-width: 768px){

  .chip,
  .badge{
    font-size:10px;
    padding:3px 8px;
  }
}
@media (max-width: 768px){

  .alert-item{
    padding:6px 8px;
  }

  .alert-icon{
    font-size:16px;
  }
}
@media (max-width: 768px){
  input, select, textarea{
    padding:9px 10px;
    font-size:13px;
  }
}
@media (max-width: 480px){

  /* Filter bars stack instead of overflow */
  .view-container .card > div[style*="grid-template-columns"]{
    grid-template-columns: 1fr !important;
  }

  .view-container .card > div{
    row-gap:10px;
  }
}
.card{
  max-width:100%;
  overflow:hidden;
}
.modal-box{
  box-sizing:border-box;
}

.modal-box .card{
  max-width:100%;
}
@media (max-width: 480px){
  .modal-box .card{
    padding:10px !important;
  }
}
@media (max-width: 480px){
  input, select{
    height:40px;
    font-size:13px;
    line-height:1.2;
  }
}
/* Overview mini metrics */
.ov-metrics{
  margin-top:4px;
  margin-bottom: 4px;
  font-size:12px;
  font-weight:600;
  color:var(--muted);
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.ov-metrics span{
  white-space:nowrap;
}
@media (max-width:768px){
  .ov-metrics{
    font-size:11px;
    gap:8px;
  }
}
/* ================= STATUS CHIPS ================= */
.status-chip{
  margin-top: 8px;
  margin-left: -4px;
  padding:4px 6px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  letter-spacing:.3px;
  text-transform:uppercase;
  white-space:nowrap;
}

.status-upcoming{
  background:rgba(56,189,248,.18);
  color:#38bdf8;
}

.status-running{
  background:rgba(16,185,129,.18);
  color:#10b981;
}

.status-ended{
  background:rgba(148,163,184,.18);
  color:#94a3b8;
}
/* ======================================================
   PREMIUM TIME & VOTE DISPLAY
====================================================== */

/* Time wrapper */
.time-box{
  margin-top:6px;
  margin-left: -4px;
  margin-bottom: 3px;
  padding:8px 12px;
  border-radius:12px;
  background:rgba(2,6,23,.55);
  border:1px solid rgba(148,163,184,.18);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-size:12px;
}
/* Prevent date wrapping */
.time-box{
  flex-wrap:nowrap;
}

.time-value{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:65%;
}

/* Countdown text */
.time-label{
  color:var(--muted);
  font-weight:600;
}

.time-value{
  font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
  font-weight:800;
  letter-spacing:.6px;
}

/* Color sync with status */
.time-upcoming .time-value{ color:var(--blue); }
.time-running  .time-value{ color:var(--green); }
.time-ended    .time-value{ color:#94a3b8; }

/* Votes pill */
/* ======================================================
   PREMIUM TOTAL VOTES PILL (IMPROVED)
====================================================== */

.vote-pill{
  margin-top:0px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:7px 14px;
  border-radius:10px;

  font-size:12px;
  font-weight:900;
  letter-spacing:.4px;

  background:linear-gradient(
    135deg,
    rgba(16,185,129,.28),
    rgba(16,185,129,.12)
  );
  color:#ecfdf5;

  border:1px solid rgba(16,185,129,.45);
  box-shadow:
    inset 0 0 0 1px rgba(16,185,129,.15),
    0 6px 18px rgba(0,0,0,.35);

  white-space:nowrap;
}

/* Zero votes â€” neutral & calm */
.vote-pill.zero{
  background:linear-gradient(
    135deg,
    rgba(148,163,184,.22),
    rgba(148,163,184,.10)
  );
  color:#e5e7eb;
  border-color:rgba(148,163,184,.35);
  box-shadow:
    inset 0 0 0 1px rgba(148,163,184,.15),
    0 4px 14px rgba(0,0,0,.3);
}

/* Results tab emphasis */
[data-result-card] .vote-pill{
  margin-top:12x;
  font-size:13px;
  padding:8px 16px;
}
.icon{
  width:16px;
  height:16px;
  fill:currentColor;
  flex-shrink:0;
}

.card h3{
  letter-spacing:.2px;
}
.filter-grid{
  display:grid;
  grid-template-columns:1fr 160px 160px;
  gap:12px;
}
.media-box{
  width:100%;
  aspect-ratio:1/1;
  overflow:hidden;
  border-radius:12px;
}
.media-box img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ================= PREMIUM RESULT CARD ================= */

.result-card{
  position:relative;
  padding:22px;
  border-radius:22px;
  background:linear-gradient(
    180deg,
    rgba(30,41,59,.75),
    rgba(2,6,23,.95)
  );
  border:1px solid rgba(148,163,184,.15);
  transition:.3s ease;
}

.result-card:hover{
  transform:translateY(-3px);
  box-shadow:0 30px 80px rgba(0,0,0,.55);
}

/* Status position */
.result-card .result-status{
  position:absolute;
  top:16px;
  right:16px;
}



.flash-message.error{
  color:#f87171;
}

.flash-message.success{
  color:#4ade80;
}

.flash-message.warning{
  color:#facc15;
}

.flash-box button{
  background:#2563eb;
  color:#fff;
  border:none;
  padding:8px 18px;
  border-radius:8px;
  cursor:pointer;
}

@keyframes scaleIn{
  from{transform:scale(.9);opacity:0}
  to{transform:scale(1);opacity:1}
}
/* ================= WHITELIST SELECTION UI ================= */

.wl-action-bar{
  display:flex;
  align-items:center;
  gap:10px;
  margin:12px 0 14px;
  flex-wrap:wrap;
}

.wl-select-all{
  display:none;
  align-items:center;
  gap:6px;
  font-size:12px;
  color:var(--muted);
  font-weight:600;
}

/* Custom checkbox */
.wl-check,
#wlSelectAll{
  appearance:none;
  width:16px;
  height:16px;
  border-radius:5px;
  border:1.5px solid var(--border);
  background:rgba(2,6,23,.9);
  display:inline-grid;
  place-items:center;
  cursor:pointer;
}

/* Hide whitelist checkboxes by default */
.wl-check{
  display:none;
}

.wl-check:checked,
#wlSelectAll:checked{
  background:linear-gradient(135deg,var(--blue),var(--indigo));
  border-color:transparent;
}

.wl-check:checked::after,
#wlSelectAll:checked::after{
  content:"";
  width:6px;
  height:10px;
  border-right:2px solid #fff;
  border-bottom:2px solid #fff;

  /* original rotation + micro offset */
  transform: translate(-3px, -6px) rotate(45deg);
}




/* Hide buttons by default (JS controls visibility) */
#wlSelectAllWrap,
#wlDeleteSelectedBtn,
#wlCancelBtn{
  display:none;
}
/* Whitelist row */
.wl-row{
  padding:10px;
  display:flex;
  align-items:center;
  gap:8px;                 /* tight gap */
}

.wl-email{
  flex:1;
  font-weight:600;
  font-size:14px;
  word-break:break-all;
}
/* ================= WHITELIST ACTION BAR LAYOUT ================= */

.wl-action-bar{
  display:flex;
  align-items:center;
  justify-content:space-between; /* ðŸ”‘ split left / right */
  gap:10px;
  margin:12px 0 14px;
  flex-wrap:wrap;
}

.wl-left{
  display:flex;
  align-items:center;
  gap:10px;
}

.wl-right{
  display:flex;
  align-items:center;
  gap:8px;
  margin-left:auto; /* ðŸ”‘ forces right alignment */
}

/* Close button tighter */
#wlCancelBtn{
  padding:8px 10px;
  font-size:14px;
}
.election-grid .empty-card{
  grid-column: 1 / -1;   /* span full grid */
  max-width: 100%;
}
.empty-card + .bottom-spacer{
  display:none;
}
.profile-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  padding:14px 0;
  border-bottom:1px solid var(--border);
}

.profile-left{
  flex:1;
}

.profile-actions{
  display:flex;
  align-items:center;
}

.icon-btn{
  background:rgba(255,255,255,.04);
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px;
  cursor:pointer;
  transition:.2s ease;
}

.icon-btn:hover{
  background:rgba(56,189,248,.12);
  border-color:var(--blue);
}

.profile-input{
  display:none;
  margin-top:6px;
}

.profile-row.editing .profile-value{
  display:none;
}

.profile-row.editing .profile-input{
  display:block;
}

.profile-input{
  transition:.2s ease;
}
.profile-row.editing .profile-input{
  opacity:1;
}
@media (max-width:768px){

  .modal-footer{
    flex-direction:column;
    gap:10px;
  }

  .modal-footer .btn{
    width:100%;
    justify-content:center;
  }

  /* Destructive buttons visually separated */
  .modal-footer .btn-danger{
    margin-top:4px;
  }

}
.public-code{
  background:rgba(56,189,248,.15);
  border:1px solid rgba(56,189,248,.35);
  padding:6px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  letter-spacing:.6px;
  color:#fff;
}

.public-code span{
  color:var(--blue);
  font-weight:900;
}

.result-card{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.result-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

.result-meta{
  font-size:12px;
  color:var(--muted);
  margin-top:2px;
}

.result-actions{
  display:flex;
  gap:10px;
}
.candidate-actions{
  display:flex;
  gap:6px;
}

@media (max-width:768px){
  .candidate-actions{
    flex-direction:column;
    width:90px;
  }

  .candidate-actions .btn{
    width:100%;
  }
}
@media (max-width:768px){
  .modal-box{
    margin:0 auto !important;
    position:relative;
    top:auto !important;
    transform:none !important;
  }
}
</style>
</head>

<body>
  <div id="toastContainer"></div>
<!-- SVG ICON DEFINITIONS -->
<svg style="display:none">

          <symbol id="icon-logout" width="16" height="16"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
</symbol>
  <!-- Alert icons -->
  <symbol id="icon-alert-critical" viewBox="0 0 24 24">
    <path d="M12 2 1 21h22L12 2zm1 15h-2v-2h2v2zm0-4h-2V9h2v4z"/>
  </symbol>

  <symbol id="icon-alert-warning" viewBox="0 0 24 24">
    <path d="M12 2 1 21h22L12 2zm1 13h-2v-4h2v4zm0 4h-2v-2h2v2z"/>
  </symbol>

  <symbol id="icon-alert-info" viewBox="0 0 24 24">
    <path d="M11 9h2V7h-2v2zm0 8h2v-6h-2v6zm1-14a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/>
  </symbol>
 <symbol id="icon-edit" viewBox="0 0 24 24">
  <path d="M3 17.25V21h3.75L19.81 7.94l-3.75-3.75L3 17.25zM20.71 
  6.04a1 1 0 0 0 0-1.41l-1.34-1.34a1 1 0 0 0-1.41 
  0l-1.13 1.13 3.75 3.75 1.13-1.13z"/>
</symbol>

  <!-- Empty state icons -->
  <symbol id="icon-ballot" viewBox="0 0 24 24">
    <path d="M3 4h18v2H3V4zm2 4h14v12H5V8zm3 2v2h4v-2H8z"/>
  </symbol>

  <symbol id="icon-chart" viewBox="0 0 24 24">
    <path d="M3 3h2v18H3V3zm6 6h2v12H9V9zm6-4h2v16h-2V5zm6 8h2v8h-2v-8z"/>
  </symbol>

  <symbol id="icon-user" viewBox="0 0 24 24">
    <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm-8 9a8 8 0 0 1 16 0z"/>
  </symbol>

  <symbol id="icon-mail" viewBox="0 0 24 24">
    <path d="M2 4h20v16H2V4zm10 7 8-5H4l8 5zm0 2-8-5v10h16V8l-8 5z"/>
  </symbol>

</svg>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar">
<div class="sidebar-brand">
  <img
    src="/static/uploads/votecentral-logo.svg"
    alt="VoteCentral"
    style="height:28px; display:block;"
  >
  <small style="display:block;font-size:11px;color:var(--muted);font-weight:600">
    Admin Console
  </small>
</div>


  <ul class="nav-menu">
    <li class="nav-item active" onclick="switchView('dashboard')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M3 13h8V3H3v10zm10 8h8V3h-8v18zM3 21h8v-6H3v6z"/>
  </svg>
  Dashboard
</li>

    <li class="nav-item" onclick="switchView('overview')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/>
  </svg>
  Overview
</li>

    <li class="nav-item" onclick="switchView('elections')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M4 10h16v10H4V10zm8-8l6 4H6l6-4z"/>
  </svg>
  Elections
</li>


    <li class="nav-item" onclick="switchView('results')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M6 3h12v4a6 6 0 0 1-12 0V3zm3 18h6v-2H9v2zm-2-4h10v-2H7v2z"/>
  </svg>
  Results
</li>

    <li class="nav-item" onclick="switchView('profile')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm-8 9a8 8 0 0 1 16 0z"/>
  </svg>
  Profile
</li>

  </ul>

  <div class="sidebar-footer">
<button class="btn btn-danger" style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px"
        onclick="openLogoutConfirm()">
  <svg class="icon"><use href="#icon-logout"></use></svg>
  Logout
</button>



  </div>
</aside>

<!-- ================= MOBILE NAV ================= -->
<nav class="mobile-nav">
  <div class="m-nav-item" data-view="dashboard" onclick="switchView('dashboard')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M3 13h8V3H3v10zm10 8h8V3h-8v18zM3 21h8v-6H3v6z"/>
  </svg>
  <div>Dash</div>
</div>

  <div class="m-nav-item" data-view="overview" onclick="switchView('overview')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/>
  </svg>
  <div>View</div>
</div>

  <div class="m-nav-item" data-view="elections" onclick="switchView('elections')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M4 10h16v10H4V10zm8-8l6 4H6l6-4z"/>
  </svg>
  <div>Vote</div>
</div>

  <div class="m-nav-item" data-view="results" onclick="switchView('results')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M6 3h12v4a6 6 0 0 1-12 0V3zm3 18h6v-2H9v2zm-2-4h10v-2H7v2z"/>
  </svg>
  <div>Win</div>
</div>

  <div class="m-nav-item" data-view="profile" onclick="switchView('profile')">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm-8 9a8 8 0 0 1 16 0z"/>
  </svg>
  <div>Me</div>
</div>

</nav>


<!-- ================= MAIN ================= -->
<main class="main-wrapper">

<header class="top-header">
  

  <div class="header-title-group">
  <img
    src="/static/uploads/votecentral-logo.svg"
    alt="VoteCentral"
    class="mobile-title-logo"
  >
  <h2 id="view-title">Dashboard</h2>
</div>

  <div id="header-actions" style="display:flex;gap:10px">
    <button
      id="newElectionBtn"
      class="btn btn-primary"
      onclick="openModal('createElectionModal')">
      + New Election
    </button>
  </div>
</header>


<!-- ================= DASHBOARD ================= -->
<section id="dashboard" class="view-container">
  <div class="stat-grid">

    <!-- TOTAL -->
    <div class="card">
      <small>Total Elections</small>
      <h1>{{ elections|length }}</h1>
    
    </div>

    <!-- RUNNING -->
    <div class="card">
      <small>Running Elections</small>
      <h1 style="color:var(--green)">
        {{ elections|selectattr("is_running")|list|length }}
      </h1>

      <div class="stat-breakdown">
        <span class="chip chip-public">
          Public:
          {{
            elections
            | selectattr("is_running")
            | selectattr("election_type","equalto","public")
            | list | length
          }}
        </span>

        <span class="chip chip-private">
          Private:
          {{
            elections
            | selectattr("is_running")
            | selectattr("election_type","equalto","private")
            | list | length
          }}
        </span>
      </div>
    </div>

    <!-- PUBLIC -->
    <div class="card">
      <small>Public Elections</small>
      <h1 style="color:#34d399">
        {{ elections|selectattr("election_type","equalto","public")|list|length }}
      </h1>

      <div class="stat-breakdown">
        <span class="chip chip-running">
          Running:
          {{
            elections
            | selectattr("election_type","equalto","public")
            | selectattr("is_running")
            | list | length
          }}
        </span>

        <span class="chip chip-upcoming">
          Upcoming:
          {{ elections
            | selectattr("election_type","equalto","public")
            | selectattr("is_upcoming")
            | list | length }}
        </span>

        <span class="chip chip-ended">
          Ended:
          {{
            elections
            | selectattr("election_type","equalto","public")
            | selectattr("is_ended")
            | list | length
          }}
        </span>
      </div>
    </div>

    <!-- PRIVATE -->
    <div class="card">
      <small>Private Elections</small>
      <h1 style="color:#818cf8">
        {{ elections|selectattr("election_type","equalto","private")|list|length }}
      </h1>

      <div class="stat-breakdown">
        <span class="chip chip-running">
          Running:
          {{
            elections
            | selectattr("election_type","equalto","private")
            | selectattr("is_running")
            | list | length
          }}
        </span>

        <span class="chip chip-upcoming">
          Upcoming:
          {{
            elections
            | selectattr("election_type","equalto","private")
            | selectattr("is_upcoming")
            | list | length
          }}
        </span>

        <span class="chip chip-ended">
          Ended:
          {{
            elections
            | selectattr("election_type","equalto","private")
            | selectattr("is_ended")
            | list | length
          }}
        </span>
      </div>
    </div>

  </div>
{% set alerts = [] %}

{# ðŸ”´ Critical: Running but no votes #}
{% for e in elections if e.is_running and e.total_votes == 0 %}
  {% set _ = alerts.append({
    "level": "critical",
    "icon": "critical",
    "text": "Running election <b>" ~ e.name ~ "</b> has no votes yet",
    "action": "candidates",
    "id": e.id,
    "name": e.name,
    "start": e.start_time,
    "end": e.end_time
  }) %}
{% endfor %}

{# ðŸŸ¡ Warning: Private with empty whitelist #}
{% for e in elections if e.election_type == "private" and e.whitelist|length == 0 %}
  {% set _ = alerts.append({
    "level": "warning",
    "icon": "warning",
    "text": "Private election <b>" ~ e.name ~ "</b> has an empty whitelist",
    "action": "whitelist",
    "id": e.id,
    "name": e.name,
    "start": e.start_time,
    "end": e.end_time
  }) %}
{% endfor %}

{# ðŸ”µ Info: Starting soon #}
{% for e in elections if e.is_upcoming and e.starts_within_24h %}
  {% set _ = alerts.append({
    "level": "info",
    "icon": "info",
    "text": "Election <b>" ~ e.name ~ "</b> starts within 24 hours",
    "action": "scroll",
    "id": e.id
  }) %}
{% endfor %}


{% if alerts|length > 0 %}
<div class="card" style="
  border:1px solid rgba(245,158,11,.25);
  background:linear-gradient(
    180deg,
    rgba(245,158,11,.08),
    rgba(2,6,23,.9)
  );
">

  <div style="
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:14px;
  ">
    <div style="
      width:42px;
      height:42px;
      border-radius:12px;
      background:rgba(245,158,11,.18);
      display:flex;
      align-items:center;
      justify-content:center;
    ">
      <svg class="icon" viewBox="0 0 24 24">
        <use href="#icon-alert-warning"></use>
      </svg>
    </div>

    <div>
      <div style="font-weight:800;font-size:16px">
        Attention Required
      </div>
      <div style="font-size:12px;color:var(--muted)">
        Review important election alerts
      </div>
    </div>
  </div>

  <div style="display:flex;flex-direction:column;gap:10px">
    {% for a in alerts %}
      <div class="alert-item alert-{{ a.level }}"
           style="
             background:rgba(255,255,255,.04);
             border-radius:12px;
             padding:10px 12px;
           "
           onclick="handleDashboardAlert(
             '{{ a.action }}',
             '{{ a.id }}',
             '{{ a.name|default('') }}',
             '{{ a.start|default('') }}',
             '{{ a.end|default('') }}'
           )">

        <svg class="icon">
          <use href="#icon-alert-{{ a.icon }}"></use>
        </svg>

        <span class="alert-text">
          {{ a.text | safe }}
        </span>

      </div>
    {% endfor %}
  </div>
</div>

{% endif %}

  <!-- QUICK ACTIONS -->
  <div class="card">
    <h3>Quick Actions</h3>
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:10px">
      <button class="btn btn-primary" onclick="openModal('createElectionModal')">
        + Create Election
      </button>
      <button class="btn btn-outline" onclick="switchView('elections')">
        Manage Elections
      </button>
      <button class="btn btn-outline" onclick="switchView('results')">
        View Results
      </button>
    </div>
  </div>
  <div class="bottom-spacer"></div>
</section>


<!-- ================= OVERVIEW ================= -->
<section id="overview" class="view-container">
  {% if elections|length > 0 %}
<div class="card">
  <div style="display:grid;grid-template-columns:1fr 160px 160px;gap:12px">
    <input id="overviewSearch" placeholder="Search elections...">

    <select id="overviewTypeFilter">
      <option value="all">All Types</option>
      <option value="public">Public</option>
      <option value="private">Private</option>
    </select>

    <select id="overviewStatusFilter">
      <option value="all">All Status</option>
      <option value="running">Running</option>
      <option value="upcoming">Upcoming</option>
      <option value="ended">Ended</option>
    </select>
  </div>
</div>
{% endif %}
{% if elections|length == 0 %}

<div class="empty-card">
  <div class="empty-icon">
    <svg viewBox="0 0 24 24">
      <use href="#icon-ballot"></use>
    </svg>
  </div>

  <div class="empty-title">No Elections Available</div>

  <div class="empty-text">
    There are no elections to display in the overview section.
  </div>

  <div class="empty-meta">
    Create your first election to start managing voting sessions.
  </div>

  <div class="empty-action">
    <button class="btn btn-primary"
            onclick="openModal('createElectionModal')">
      + Create Election
    </button>
  </div>
</div>

{% else %}

    <div class="election-grid" id="overviewGrid">
      <div id="overviewEmpty" class="empty-card" style="display:none">
  <div class="empty-icon">
    <svg viewBox="0 0 24 24">
      <use href="#icon-ballot"></use>
    </svg>
  </div>

  <div class="empty-title">No Matching Elections</div>
  <div class="empty-text">
    No elections match your current filters.
  </div>
  <div class="empty-meta">
    Adjust search criteria or reset filters.
  </div>
</div>

      {% for e in elections %}
      <div class="card"
           data-ov-card
           data-type="{{ e.election_type }}"
           data-name="{{ e.name|lower }}"
           data-code="{{ e.public_code|lower if e.public_code }}"
           data-start="{{ e.start_time }}"
           data-end="{{ e.end_time }}">
        <div style="display:flex;justify-content:space-between;align-items:center">
  <div>
    <b>{{ e.name }}</b>
    <div style="font-size:12px;color:var(--muted);margin-top:3px;font-weight: bold;">
      {{ e.election_type|upper }}
    </div>
  </div>

  {% if e.election_type == "public" and e.public_code %}
<div class="public-code">
  Public Code: <span>{{ e.public_code }}</span>
</div>

  {% endif %}
</div>


        <div class="status-chip" data-status-chip></div>
        <div class="time-box">
  <span class="time-label">Time</span>
  <span class="time-value countdown-timer"></span>
</div>

        <div class="ov-metrics">
  <span>Candidates: {{ e.candidates|length }}</span>
  <span>Votes: {{ e.total_votes }}</span>


  {% if e.election_type == "private" %}
    <span>Whitelist: {{ e.whitelist|length }}</span>
  {% endif %}
</div>

       
      </div>
      {% endfor %}
      
    </div>
    {% endif %}
  </div>
  <div class="bottom-spacer"></div>
</section>

<!-- ================= ELECTIONS ================= -->
<section id="elections" class="view-container">
   {% if elections|length > 0 %}
    <div class="card">
  <div style="display:grid;grid-template-columns:1fr 160px 160px;gap:12px">
    <input id="electionSearch" placeholder="Search elections...">

    <select id="electionTypeFilter">
      <option value="all">All Types</option>
      <option value="public">Public</option>
      <option value="private">Private</option>
    </select>

    <select id="electionStatusFilter">
      <option value="all">All Status</option>
      <option value="running">Running</option>
      <option value="upcoming">Upcoming</option>
      <option value="ended">Ended</option>
    </select>
  </div>
</div>
{% endif %}
{% if elections|length == 0 %}
<div class="empty-card">
  <div class="empty-icon">
    <svg viewBox="0 0 24 24">
      <use href="#icon-chart"></use>
    </svg>
  </div>

  <div class="empty-title">No Elections Created</div>

  <div class="empty-text">
    No elections exist yet. Create your first election to begin managing voting sessions.
  </div>

  <div class="empty-meta">
    Define schedule, candidates, and access control.
  </div>

  <div class="empty-action">
    <button class="btn btn-primary"
            onclick="openModal('createElectionModal')">
      + Create Election
    </button>
  </div>
</div>

{% endif %}


  <div class="election-grid">
    <div id="electionsEmpty" class="empty-card" style="display:none">
  <div class="empty-icon">
    <svg viewBox="0 0 24 24">
      <use href="#icon-ballot"></use>
    </svg>
  </div>

  <div class="empty-title">No Matching Elections</div>

  <div class="empty-text">
    No elections match your current filters.
  </div>

  <div class="empty-meta">
    Adjust search criteria or reset filters.
  </div>
</div>

    {% for e in elections %}
<div class="card"
     data-election-card
     data-type="{{ e.election_type }}"
     data-name="{{ e.name|lower }}"
     data-code="{{ e.public_code|lower if e.public_code }}"
     data-start="{{ e.start_time }}"
     data-end="{{ e.end_time }}">


  <div style="display:flex;justify-content:space-between;align-items:center">
  <div>
    <h3 style="margin:0">{{ e.name }}</h3>
    <div style="font-size:12px;color:var(--muted);margin-top:3px;font-weight:600;">
      {{ e.election_type|upper }}
    </div>
  </div>

  {% if e.election_type == "public" and e.public_code %}
 <div class="public-code">
  Public Code: <span>{{ e.public_code }}</span>
</div>

  {% endif %}
</div>

<div
  class="status-chip"
  data-status-chip
></div>

      <div class="time-box">
  <span class="time-label">Time</span>
  <span class="time-value countdown-timer"></span>
</div>

      <p class="election-state-note" hidden></p>
      <button class="btn btn-primary"
        onclick="
          rememberModal('candidates','{{ e.id }}','{{ e.name }}');
          openManageCandidates(
            '{{ e.id }}',
            '{{ e.name }}',
            '{{ e.start_time }}',
            '{{ e.end_time }}'
          );
        ">
        Manage Candidates
      </button>


      {% if e.election_type == "private" %}
      <button class="btn btn-outline"
        onclick="
          rememberModal('whitelist','{{ e.id }}','{{ e.name }}');
          openWhitelist(
            '{{ e.id }}',
            '{{ e.name }}',
            '{{ e.start_time }}',
            '{{ e.end_time }}'
          );
        ">
        Whitelist
      </button>


      {% endif %}
      <button class="btn btn-outline" onclick="openEditElection('{{ e.id }}','{{ e.name }}','{{ e.start_time }}','{{ e.end_time }}')">Edit</button>
    </div>
    {% endfor %}
  </div>
  <div class="bottom-spacer"></div>
</section>

<!-- ================= RESULTS ================= -->
<section id="results" class="view-container">
{% set total_votes = elections | sum(attribute='total_votes') %}


  <!-- FILTER BAR -->
    {% if elections|length > 0 %}
  <div class="card">
    <div style="display:grid;grid-template-columns:1fr 160px 160px;gap:12px">
      <input id="resultsSearch" placeholder="Search elections...">

      <select id="resultsTypeFilter">
        <option value="all">All Types</option>
        <option value="public">Public</option>
        <option value="private">Private</option>
      </select>

      <select id="resultsStatusFilter">
        <option value="all">All Status</option>
        <option value="running">Running</option>
        <option value="upcoming">Upcoming</option>
        <option value="ended">Ended</option>
      </select>
    </div>
  </div>
{% endif %}
  <!-- RESULTS GRID -->
{% if elections|length == 0 %}

<div class="empty-card">
  <div class="empty-icon">
    <svg viewBox="0 0 24 24">
      <use href="#icon-chart"></use>
    </svg>
  </div>

  <div class="empty-title">No Results Yet</div>

  <div class="empty-text">
    No elections exist, so there are no results to display.
  </div>

  <div class="empty-meta">
    Results will appear here once elections are created and completed.
  </div>

  <div class="empty-action">
    <button class="btn btn-primary"
            onclick="openModal('createElectionModal')">
      + Create Election
    </button>
  </div>
</div>

{% else %}

<div class="election-grid">

    <div id="resultsEmpty" class="empty-card" style="display:none">
  <div class="empty-icon">
    <svg viewBox="0 0 24 24">
      <use href="#icon-chart"></use>
    </svg>
  </div>

  <div class="empty-title">No Matching Results</div>
  <div class="empty-text">
    No elections match your selected filters.
  </div>
  <div class="empty-meta">
    Results become available after elections conclude.
  </div>
</div>

    {% for e in elections %}
<div class="card result-card"
     data-result-card
     data-type="{{ e.election_type }}"
     data-name="{{ e.name|lower }}"
     data-code="{{ e.public_code|lower if e.public_code }}"
     data-start="{{ e.start_time }}"
     data-end="{{ e.end_time }}">


  


  <div class="result-header">
    <div>
      <b>{{ e.name }}</b>
      <div class="result-meta" style="font-weight: bold;">
        {{ e.election_type|upper }}
      </div>
    </div>

    {% if e.election_type == "public" and e.public_code %}
   <div class="public-code">
  Public Code: <span>{{ e.public_code }}</span>
</div>

    {% endif %}
  </div>
<div class="result-status" data-status-chip></div>
  <div class="vote-pill {{ 'zero' if e.total_votes == 0 }}">
   Total Votes: {{ e.total_votes }} 
  </div>

  <div class="result-actions">
    <button class="btn btn-primary"
      onclick="handleResultAccess(
        '{{ e.id }}',
        '{{ e.election_type }}',
        '{{ e.start_time }}',
        '{{ e.end_time }}'
      )">
      Open Result
    </button>

    <button class="btn btn-outline"
      onclick="toggleResultVisibility('{{ e.id }}')">
      {% if e.result_visible %}
        Hide
      {% else %}
        Publish
      {% endif %}
    </button>
  </div>

</div>

    {% endfor %}
    
  </div>
  {% endif %}
  <div class="bottom-spacer"></div>

</section>

<!-- ================= PROFILE ================= -->
<section id="profile" class="view-container">
  <div class="card" style="max-width:520px">

    <h3 style="margin-bottom:10px">Admin Profile</h3>

    <!-- NAME -->
    <div class="profile-row" data-field="Name">
      <div>
        <div class="profile-label">Name</div>
        <div id="profileName" class="profile-value">{{ admin.name }}</div>
        <input id="profileNameInput" class="profile-input" value="{{ admin.name }}">
      </div>
      <button class="edit-btn" onclick="toggleEdit('Name')">
         <svg class="icon"><use href="#icon-edit"></use></svg>
      </button>
    </div>

    <!-- USERNAME -->
    <div class="profile-row" data-field="Username">
      <div>
        <div class="profile-label">Username</div>
        <div id="profileUsername" class="profile-value">{{ admin.username }}</div>
        <input id="profileUsernameInput" class="profile-input" value="{{ admin.username }}">
      </div>
      <button class="edit-btn" onclick="toggleEdit('Username')">
         <svg class="icon"><use href="#icon-edit"></use></svg>
      </button>
    </div>

    <!-- MOBILE -->
    <div class="profile-row" data-field="Mobile">
      <div>
        <div class="profile-label">Mobile Number</div>
        <div id="profileMobile" class="profile-value">{{ admin.mobile or "Not set" }}</div>
        <input id="profileMobileInput" class="profile-input" value="{{ admin.mobile or '' }}" placeholder="+91xxxxxxxxxx">
      </div>
      <button class="edit-btn" onclick="toggleEdit('Mobile')">
         <svg class="icon"><use href="#icon-edit"></use></svg>
      </button>
    </div>

    <!-- WHATSAPP -->
    <div class="profile-row" data-field="Whatsapp">
      <div>
        <div class="profile-label">WhatsApp Link</div>
        <div id="profileWhatsapp" class="profile-value">
          {{ admin.whatsapp or "Not set" }}
        </div>
        <input id="profileWhatsappInput" class="profile-input" value="{{ admin.whatsapp or '' }}" placeholder="https://wa.me/91xxxxxxxxxx">
      </div>
      <button class="edit-btn" onclick="toggleEdit('Whatsapp')">
         <svg class="icon"><use href="#icon-edit"></use></svg>
      </button>
    </div>

    <!-- ADMIN CODE -->
    <div class="profile-row">
      <div>
        <div class="profile-label">Admin Code</div>
        <div class="profile-value">{{ admin.admin_code }}</div>
      </div>
    </div>

<button
  id="saveProfileBtn"
  class="btn btn-primary"
  style="margin-top:14px; display:none"
  onclick="saveProfile()">
  Save Changes
</button>


  </div>
</section>

</main>

<!-- ================= MODALS (ALL REQUIRED) ================= -->


<div id="createElectionModal" class="modal">
  <div class="modal-box">

    <div class="modal-header">
      <div class="modal-title">Create New Election</div>
      <button class="modal-close" onclick="closeModals()">âœ•</button>
    </div>

    <form method="POST"
          action="/admin/create-election"
          class="modal-body modal-form">

      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="form-group">
        <label class="form-label">Election Name</label>
        <input name="name" placeholder="Enter election name" required>
      </div>

      <div class="form-group">
        <label class="form-label">Election Type</label>
        <select name="type">
          <option value="public">Public</option>
          <option value="private">Private</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Start Date & Time</label>
        <input type="datetime-local" name="start_time">
      </div>

      <div class="form-group">
        <label class="form-label">End Date & Time</label>
        <input type="datetime-local" name="end_time">
      </div>

      <div class="modal-footer">
        <button type="button"
                class="btn btn-outline"
                onclick="closeModals()">
          Cancel
        </button>

        <button class="btn btn-primary">
          Create Election
        </button>
      </div>

    </form>
  </div>
</div>
<div id="editElectionModal" class="modal">
  <div class="modal-box">

    <!-- HEADER -->
    <div class="modal-header">
      <div class="modal-title">Edit Election</div>
      <button class="modal-close" onclick="closeModals()">âœ•</button>
    </div>

    <!-- BODY -->
    <form method="POST"
          action="/admin/election/update"
          class="modal-body modal-form">

      <input type="hidden" id="editElectionId" name="election_id">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="form-group">
        <label class="form-label">Election Name</label>
        <input id="editElectionName"
               name="name"
               placeholder="Enter election name">
      </div>

      <div class="form-group">
        <label class="form-label">Start Date & Time</label>
        <input type="datetime-local"
               id="editElectionStart"
               name="start_time">
      </div>

      <div class="form-group">
        <label class="form-label">End Date & Time</label>
        <input type="datetime-local"
               id="editElectionEnd"
               name="end_time">
      </div>

      <!-- FOOTER -->
      <div class="modal-footer">

       

        <button type="button"
                id="deleteElectionBtn"
                class="btn btn-danger"
                onclick="confirmDeleteElection()">
          Delete
        </button>

        <button type="button"
                id="forceDeleteElectionBtn"
                class="btn btn-outline"
                onclick="confirmForceDeleteElection()">
          Force Delete
        </button>

        <button class="btn btn-primary">
          Save Changes
        </button>

      </div>

    </form>

  </div>
</div>


<!-- MANAGE CANDIDATES -->
<div id="manageCandidatesModal" class="modal">
  <div class="modal-box">

    <div class="modal-header">
      <div class="modal-title" id="mcTitle">Manage Candidates</div>
      <button class="modal-close" onclick="closeModals()">âœ•</button>
    </div>

    <div class="modal-body modal-form">

      <form method="POST"
            action="/admin/add-candidate"
            enctype="multipart/form-data"
            onsubmit="return handleCandidateImageSubmit(this)"
            class="modal-form">

        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="mcElectionId" name="election_id">

        <div class="form-group">
          <label class="form-label">Candidate Name</label>
          <input name="name" required>
        </div>

        <div class="form-group">
          <label class="form-label">Party</label>
          <input name="party">
        </div>

        <div class="form-group">
          <label class="form-label">Photo (1:1 Square)</label>
          <input type="file" name="photo">
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea name="description"></textarea>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary">
            Add Candidate
          </button>
        </div>
      </form>

      <div class="form-group">
        <label class="form-label">Search Candidates</label>
        <input id="mcSearchInput" placeholder="Search candidates">
      </div>

      <div id="mcList"></div>

    </div>
  </div>
</div>


<!-- EDIT CANDIDATE -->
<div id="editCandidateModal" class="modal">
  <div class="modal-box">

    <div class="modal-header">
      <div class="modal-title">Edit Candidate</div>
      <button class="modal-close"
        onclick="closeModals('editCandidateModal')">âœ•</button>

    </div>

    <form method="POST"
          action="/admin/candidate/update"
          enctype="multipart/form-data"
          onsubmit="return handleCandidateImageSubmit(this)"
          class="modal-body modal-form">

      <input type="hidden" id="editCandidateId" name="candidate_id">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="form-group">
        <label class="form-label">Candidate Name</label>
        <input id="editCandidateName" disabled>
      </div>

      <div class="form-group">
        <label class="form-label">Party</label>
        <input id="editCandidateParty" name="party">
      </div>

      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea id="editCandidateDesc" name="description"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Update Photo</label>
        <input type="file" name="photo">
      </div>

      <div class="modal-footer">
  

        <button type="button"
                class="btn btn-danger"
                onclick="confirmDeleteCandidate()">
          Delete
        </button>

        <button class="btn btn-primary">
          Save Changes
        </button>
      </div>

    </form>
  </div>
</div>


<!-- WHITELIST -->
<div id="whitelistModal" class="modal">
  <div class="modal-box">

    <!-- HEADER -->
    <div class="modal-header">
      <div class="modal-title" id="wlTitle">Whitelist</div>
      <button class="modal-close" onclick="closeModals()">âœ•</button>
    </div>

    <!-- BODY -->
    <div class="modal-body modal-form">

      <!-- Count -->
      <div class="form-group">
        <label class="form-label">Total Entries</label>
        <div id="wlCount" style="color:var(--muted);font-weight:600">
          Total: 0
        </div>
      </div>

      <!-- ADD EMAILS -->
      <form method="POST"
            action="/admin/whitelist/bulk-add"
            class="modal-form">

        <input type="hidden" id="wlElectionId" name="election_id">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="form-group">
          <label class="form-label">Add Emails</label>
          <textarea name="emails"
                    placeholder="Enter emails separated by commas"
                    rows="4"></textarea>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary">
            Add Emails
          </button>
        </div>
      </form>

      <!-- SEARCH -->
      <div class="form-group">
        <label class="form-label">Search Whitelist</label>
        <input id="wlSearchInput"
               placeholder="Search email">
      </div>

      <!-- ACTION BAR -->
      <div class="wl-action-bar">

        <div class="wl-left">
          <button id="wlSelectBtn"
                  class="btn btn-outline"
                  onclick="enableWhitelistSelection()">
            Select
          </button>

          <label id="wlSelectAllWrap"
                 class="wl-select-all">
            <input type="checkbox" id="wlSelectAll">
            Select All
          </label>
        </div>

        <div class="wl-right">
          <button id="wlDeleteSelectedBtn"
                  class="btn btn-danger"
                  onclick="confirmBulkDelete()">
            Delete Selected
          </button>

          <button id="wlCancelBtn"
                  class="btn btn-outline"
                  onclick="cancelWhitelistSelection()">
            Cancel
          </button>
        </div>

      </div>

      <!-- LIST -->
      <div id="wlList"></div>

      <!-- CLOSE -->
      <div class="modal-footer">
        <button class="btn btn-outline"
                onclick="closeModals()">
          Close
        </button>
      </div>

    </div>

  </div>
</div>

<div id="alertModal" class="modal">
  <div class="modal-box" style="max-width:420px">

    <div class="modal-header">
      <div class="modal-title">Notice</div>
      <button class="modal-close" onclick="closeAlert()">âœ•</button>
    </div>

    <div class="modal-body">
      <p id="alertMessage"
         style="color:var(--muted);line-height:1.6">
      </p>

      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeAlert()">
          OK
        </button>
      </div>
    </div>

  </div>
</div>


<!-- LOGOUT CONFIRMATION -->
<div id="logoutConfirmModal" class="modal">
  <div class="modal-box" style="max-width:380px">

    <div class="modal-header">
      <div class="modal-title">Confirm Logout</div>
      <button class="modal-close" onclick="closeLogoutConfirm()">âœ•</button>
    </div>

    <div class="modal-body">

      <p style="color:var(--muted);line-height:1.6">
        Are you sure you want to log out of the admin panel?
      </p>

      <div class="modal-footer">
      

<button class="btn btn-danger"
        style="display:flex;align-items:center;justify-content:center;gap:8px"
        onclick="confirmLogout()">
  <svg class="icon"><use href="#icon-logout"></use></svg>
  Logout
</button>

      </div>

    </div>
  </div>
</div>

</div>
<!-- GLOBAL CONFIRM MODAL -->
<div id="confirmModal" class="modal">
  <div class="modal-box" style="max-width:400px">

    <div class="modal-header">
      <div class="modal-title" id="confirmTitle">Confirm Action</div>
      <button class="modal-close" onclick="closeConfirm()">âœ•</button>
    </div>

    <div class="modal-body">
      <p id="confirmMessage"
         style="color:var(--muted);line-height:1.6">
      </p>

      <div class="modal-footer">
        <button class="btn btn-outline"
                onclick="closeConfirm()">
          Cancel
        </button>

        <button id="confirmYesBtn"
                class="btn btn-danger">
          Confirm
        </button>
      </div>
    </div>

  </div>
</div>


{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<script>
  document.addEventListener("DOMContentLoaded",function(){
    {% for category, message in messages %}
      showToast({{ message|tojson }}, "{{ category.replace('_','-') }}");
    {% endfor %}
  });
</script>
{% endif %}
{% endwith %}


<script>
  const VIEW_ORDER = [
  "dashboard",
  "overview",
  "elections",
  "results",
  "profile"
];



/* ======================================================
   CORE HELPERS
====================================================== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ======================================================
   SPA VIEW SWITCHING
====================================================== */
let currentViewIndex = 0;

function switchView(viewId){
  const views = $$(".view-container");
  const newIndex = VIEW_ORDER.indexOf(viewId);
  if(newIndex === -1) return;

  const direction =
    newIndex > currentViewIndex ? "right" : "left";

  views.forEach(v=>{
    v.classList.remove(
      "active",
      "view-enter-right",
      "view-enter-left"
    );
  });

  const view = document.getElementById(viewId);
  if(!view) return;

  view.classList.add("active");
  view.classList.add(
    direction === "right"
      ? "view-enter-right"
      : "view-enter-left"
  );

  currentViewIndex = newIndex;

  /* Title update */
  const titles = {
    dashboard:"Dashboard",
    overview:"Election Overview",
    elections:"Manage Elections",
    results:"Results",
    profile:"Admin Profile"
  };
  $("#view-title").textContent = titles[viewId] || "Admin Panel";
  updateHeaderActions(viewId);


  /* Sidebar + mobile active states */
  $$(".nav-item").forEach(i=>{
    i.classList.toggle("active", i.textContent.toLowerCase().includes(viewId));
  });
  $$(".m-nav-item").forEach(i=>{
    i.classList.toggle("active", i.dataset.view === viewId);
  });

  localStorage.setItem("admin_active_view", viewId);
  view.scrollTo({ top:0 });
}

function showAlert(message){
  $("#alertMessage").textContent = message;
  $("#alertModal").style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeAlert(){
  $("#alertModal").style.display = "none";
  document.body.style.overflow = "auto";
}
function closeFlash(){
  document.getElementById("flash-overlay")?.remove();
}
let confirmAction = null;

function openConfirm(message, onConfirm, type="danger"){
  $("#confirmMessage").textContent = message;
  confirmAction = onConfirm;

  const yesBtn = $("#confirmYesBtn");

  yesBtn.classList.remove("btn-danger","btn-primary");

  if(type === "danger"){
    yesBtn.classList.add("btn-danger");
  } else {
    yesBtn.classList.add("btn-primary");
  }

  $("#confirmModal").style.display = "flex";
  document.body.style.overflow = "hidden";
}


function closeConfirm(){
  $("#confirmModal").style.display = "none";
  document.body.style.overflow = "auto";
  confirmAction = null;
}

$("#confirmYesBtn").addEventListener("click", () => {
  if(typeof confirmAction === "function"){
    confirmAction();
  }
  closeConfirm();
});
/* ======================================================
   MODALS
====================================================== */
function openModal(id){
  const m = document.getElementById(id);
  if(!m) return;
  m.style.display="flex";
  document.body.style.overflow="hidden";
}
function closeModals(targetId){

  // ðŸ”¥ CLEAR MODAL MEMORY
  localStorage.removeItem("admin_modal");

  if(targetId){
    const m = document.getElementById(targetId);
    if(m) m.style.display = "none";
  } else {
    $$(".modal").forEach(m=>m.style.display="none");
  }

  document.body.style.overflow="auto";

  document.querySelectorAll(".btn.loading").forEach(btn=>{
    btn.classList.remove("loading");
    btn.disabled = false;
  });
}




window.addEventListener("click",e=>{
  if(e.target.classList.contains("modal")) closeModals();
});
document.addEventListener("keydown", e => {
  if(e.key === "Escape"){
    closeLogoutConfirm();
  }
});

function toggleResultVisibility(id){

  fetch(`/admin/toggle-results/${id}`,{
    method:"POST",
    headers:{
      "X-CSRFToken":"{{ csrf_token() }}"
    }
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){
      showToast(res.message || "Operation failed","error");
      return;
    }

    showToast("Result visibility updated","success");

    setTimeout(()=>{
      location.reload();
    },800);
  })
  .catch(()=>{
    showToast("Network error","error");
  });
}

/* ======================================================
   EDIT / DELETE ELECTION
====================================================== */
function openEditElection(id, name, start, end){
  $("#editElectionId").value = id;
  $("#editElectionName").value = name;
function formatForDateTimeLocal(value){
  if(!value) return "";
  const d = new Date(value);
  if(isNaN(d.getTime())) return "";
  return d.toISOString().slice(0,16);
}

$("#editElectionStart").value = formatForDateTimeLocal(start);
$("#editElectionEnd").value   = formatForDateTimeLocal(end);


  // ---- LOCK RULES ----
  const now = Date.now();
  const startTs = start ? Date.parse(start) : null;
  const endTs   = end   ? Date.parse(end)   : null;

  const startInput = $("#editElectionStart");
  const endInput   = $("#editElectionEnd");

  // reset
  startInput.disabled = false;
  startInput.title = "";
  endInput.disabled = false;
  endInput.title = "";

  // ðŸ”´ election ended â†’ everything locked
  if(endTs && now >= endTs){
    startInput.disabled = true;
    endInput.disabled   = true;
    startInput.title = "Election has ended";
    endInput.title   = "Election has ended";
  }
  // ðŸŸ¡ election running â†’ start locked, end editable
  else if(startTs && now >= startTs){
    startInput.disabled = true;
    startInput.title = "Start time cannot be changed after election starts";
  }

  openModal("editElectionModal");
  const delBtn  = $("#deleteElectionBtn");
  const forceBtn = $("#forceDeleteElectionBtn");

  delBtn.style.display = "none";
  forceBtn.style.display = "none";

  if(!startTs || now < startTs){
    // upcoming
    delBtn.style.display = "inline-flex";
  }
  else if(startTs && (!endTs || now < endTs)){
    // running
    forceBtn.style.display = "inline-flex";
  }
  // ended â†’ neither shown

}

function confirmDeleteElection(){
  const id=$("#editElectionId").value;
  if(!id) return;

  openConfirm(
    "Delete this election? Only allowed if no votes exist.",
    () => location.href=`/admin/election/delete/${id}`
  );
}

function confirmForceDeleteElection(){
  const id=$("#editElectionId").value;
  if(!id) return;

openConfirm(
  "âš  FORCE DELETE will permanently remove the election, candidates, and votes.",
  () => location.href=`/admin/election/force-delete/${id}`,
  "danger"
);

}


/* ======================================================
   MANAGE CANDIDATES
====================================================== */
function openManageCandidates(eid, name, start, end){
  $("#mcElectionId").value = eid;
  $("#mcTitle").textContent = "Manage Candidates â€” " + name;

  const fakeCard = document.createElement("div");
  fakeCard.dataset.start = start;
  fakeCard.dataset.end = end;

  const status = getElectionStatus(fakeCard);
  const isRunning = status === "running";
  const isEnded   = status === "ended";

  const addBtn = document.querySelector(
    "#manageCandidatesModal form button.btn-primary"
  );

  fetch(`/admin/api/candidates/${eid}`)
    .then(r => r.json())
    .then(data => {

      const hasVotes = data.candidates.some(c => c.votes > 0);

      if(addBtn){
        addBtn.disabled = isEnded || (isRunning && hasVotes);
        addBtn.title =
          isEnded
            ? "Election has ended"
            : (isRunning && hasVotes
                ? "Cannot add candidates after votes are cast"
                : "");
      }

const list = $("#mcList");
const searchInput = $("#mcSearchInput");

if(!data.candidates.length){

  // Hide search input
  if(searchInput) searchInput.style.display = "none";

  list.innerHTML = `
    <div class="empty-card">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24">
          <use href="#icon-user"></use>
        </svg>
      </div>

      <div class="empty-title">No Candidates Added</div>

      <div class="empty-text">
        Add candidates before the election begins.
      </div>

      <div class="empty-meta">
        A minimum of 2 candidates is required to conduct voting.
      </div>
    </div>
  `;

  return;
}


list.innerHTML = data.candidates.map(c => `
  <div class="card" style="padding:12px;display:flex;gap:12px;align-items:center">

    <div class="media-box" style="width:64px;flex-shrink:0">
      <img src="/static/uploads/${c.photo || 'default-candidate.png'}">
    </div>

    <div style="flex:1">
      <b>${c.name}</b>
      <div style="font-size:13px;color:var(--muted)">
        Party: ${c.party || "Independent"}
      </div>
      <div style="font-size:13px">
        Votes: ${isEnded ? c.votes : "â€”"}
      </div>
    </div>

    <div class="candidate-actions">

      <!-- EDIT -->
      <button
        class="btn btn-outline"
        ${isEnded ? "disabled title='Election has ended'" : ""}
        onclick="openEditCandidate(
          '${c.id}',
          '${c.name}',
          '${c.party || ""}',
          '${c.description || ""}'
        )">
        Edit
      </button>

      <!-- DELETE -->
      <button
        class="btn btn-danger"
        ${(isEnded || c.votes > 0) ? "disabled title='Cannot delete candidate'" : ""}
          onclick="
            openConfirm(
              'Delete ${c.name}? This action cannot be undone.',
              () => location.href='/admin/candidate/delete/${c.id}',
              'danger'
            );
          "
        ">
        Delete
      </button>
    </div>

  </div>
`).join("");

    });

  openModal("manageCandidatesModal");
}

/* ======================================================
   EDIT CANDIDATE
====================================================== */
function openEditCandidate(id,name,party,desc){
  $("#editCandidateId").value=id;
  $("#editCandidateName").value=name;
  $("#editCandidateParty").value=party||"";
  $("#editCandidateDesc").value=desc||"";
  openModal("editCandidateModal");
}
function confirmDeleteCandidate(){
  const id = $("#editCandidateId").value;
  if(!id) return;

  openConfirm(
    "Delete this candidate? Only allowed if zero votes.",
    () => location.href=`/admin/candidate/delete/${id}`
  );
}


/* ======================================================
   WHITELIST
====================================================== */
function openWhitelist(eid, name, start, end){
  $("#wlElectionId").value = eid;
  $("#wlTitle").textContent = "Whitelist â€” " + name;

  // Determine election status
  const fakeCard = document.createElement("div");
  fakeCard.dataset.start = start;
  fakeCard.dataset.end = end;
  const isEnded = getElectionStatus(fakeCard) === "ended";

  // Disable ADD button if ended
  const addBtn = document.querySelector(
    "#whitelistModal form button.btn-primary"
  );
  if(addBtn){
    addBtn.disabled = isEnded;
    addBtn.title = isEnded ? "Election has ended" : "";
  }

  fetch(`/admin/api/whitelist/${eid}`)
    .then(r => r.json())
    .then(data => {
      const list = $("#wlList");

      // âœ… UPDATE COUNT
      $("#wlCount").textContent = `Total: ${data.whitelist.length}`;

// cache controls
const selectBtn   = document.getElementById("wlSelectBtn");
const selectAll   = document.getElementById("wlSelectAllWrap");
const deleteBtn   = document.getElementById("wlDeleteSelectedBtn");
const cancelBtn   = document.getElementById("wlCancelBtn");
const searchInput = document.getElementById("wlSearchInput");

/* ================= EMPTY WHITELIST ================= */
if(!data.whitelist.length){

  // hide selection UI
  if(selectBtn)   selectBtn.style.display = "none";
  if(selectAll)   selectAll.style.display = "none";
  if(deleteBtn)   deleteBtn.style.display = "none";
  if(cancelBtn)   cancelBtn.style.display = "none";
  if(searchInput) searchInput.style.display = "none";
  list.innerHTML = `
  <div class="empty-card">
  <div class="empty-icon">
    <svg viewBox="0 0 24 24">
      <use href="#icon-mail"></use>
    </svg>
  </div>

  <div class="empty-title">Whitelist is Empty</div>

      <div class="empty-text">
        Only whitelisted voters can participate in this private election.
        ${isEnded ? "This election has ended." : "Add voter emails to enable access."}
      </div>

  <div class="empty-meta">
    Add voter emails to grant participation rights.
  </div>
</div>
  `;
  return;
}

/* ================= NON-EMPTY WHITELIST ================= */

// show base controls
if(selectBtn)   selectBtn.style.display = "inline-flex";
if(searchInput) searchInput.style.display = "block";

// reset selection state every open

      list.innerHTML = data.whitelist
        .sort((a,b)=>a.email.localeCompare(b.email))
        .map(w => `
          <div class="card wl-row">

            ${
              w.has_voted
                ? ""
                : `<input type="checkbox" class="wl-check" value="${w.id}">`
            }

            <span class="wl-email">${w.email}</span>

            <button class="btn btn-danger"
              ${w.has_voted ? "disabled title='User has already voted'" : ""}
              onclick="location.href='/admin/whitelist/remove/${w.id}'">
              ${w.has_voted ? "Voted" : "Remove"}
            </button>

          </div>
        `).join("");
// reset selection state AFTER rows exist
cancelWhitelistSelection();
updateWhitelistUIState();

    })
    
  openModal("whitelistModal");
}
let whitelistSelectionMode = false;

function enableWhitelistSelection(){
  whitelistSelectionMode = true;

  document.querySelectorAll(".wl-check").forEach(c=>{
    if(c.closest(".wl-row").style.display !== "none"){
      c.style.display = "inline-grid";
    }
  });

  updateWhitelistUIState();
}

function cancelWhitelistSelection(){
  whitelistSelectionMode = false;

  document.querySelectorAll(".wl-check").forEach(c=>{
    c.checked = false;
    c.style.display = "none";
  });

  const selectAll = document.getElementById("wlSelectAll");
  if(selectAll) selectAll.checked = false;

  updateWhitelistUIState();
}

function updateWhitelistUIState(){
  const rows = document.querySelectorAll(".wl-row");
  const visibleRows = Array.from(rows).filter(r => r.style.display !== "none");

  const selectBtn   = document.getElementById("wlSelectBtn");
  const selectAll   = document.getElementById("wlSelectAllWrap");
  const deleteBtn   = document.getElementById("wlDeleteSelectedBtn");
  const cancelBtn   = document.getElementById("wlCancelBtn");

  const anyVisible = visibleRows.length > 0;
  const anyChecked = document.querySelectorAll(".wl-check:checked").length > 0;

  // âŒ No visible rows â†’ hide everything
  if(!anyVisible){
    if(selectBtn) selectBtn.style.display = "none";
    if(selectAll) selectAll.style.display = "none";
    if(deleteBtn) deleteBtn.style.display = "none";
    if(cancelBtn) cancelBtn.style.display = "none";
    return;
  }

  // ðŸŸ¢ Visible rows exist
  if(!whitelistSelectionMode){
    if(selectBtn) selectBtn.style.display = "inline-flex";
    if(selectAll) selectAll.style.display = "none";
    if(deleteBtn) deleteBtn.style.display = "none";
    if(cancelBtn) cancelBtn.style.display = "none";
  } else {
    if(selectBtn) selectBtn.style.display = "none";
    if(selectAll) selectAll.style.display = "flex";
    if(cancelBtn) cancelBtn.style.display = "inline-flex";
    if(deleteBtn) deleteBtn.style.display = anyChecked ? "inline-flex" : "none";
  }
}


function updateWhitelistDeleteVisibility(){
  const checked = document.querySelectorAll(".wl-check:checked").length;
  document.getElementById("wlDeleteSelectedBtn").style.display =
    checked > 0 ? "inline-flex" : "none";
}

document.addEventListener("change", e=>{

  // Individual checkbox changed
  if(e.target.classList.contains("wl-check")){
    updateWhitelistDeleteVisibility();
    syncSelectAllState();   // ðŸ”¥ ADD THIS
  }

  // Select All changed
  if(e.target.id === "wlSelectAll"){
    document.querySelectorAll(".wl-row").forEach(row=>{
      if(row.style.display === "none") return;

      const checkbox = row.querySelector(".wl-check");
      if(!checkbox) return;

      checkbox.checked = e.target.checked;
    });

    updateWhitelistDeleteVisibility();
  }

});


/* ======================================================
   SEARCH FILTERS
====================================================== */
function attachCandidateSearch(){
  const input = document.getElementById("mcSearchInput");
  const list  = document.getElementById("mcList");
  if(!input || !list) return;

  input.addEventListener("input", () => {
    const q = input.value.toLowerCase().trim();
    let visibleCount = 0;

    list.querySelectorAll(".card").forEach(card => {
      const name = card.querySelector("b")?.innerText.toLowerCase() || "";

      if(name.includes(q)){
        card.style.display = "";
        visibleCount++;
      } else {
        card.style.display = "none";
      }
    });

    // Remove previous "no result" card if exists
    const oldEmpty = document.getElementById("mcSearchEmpty");
    if(oldEmpty) oldEmpty.remove();

    if(q && visibleCount === 0){
      list.insertAdjacentHTML("beforeend", `
        <div id="mcSearchEmpty" class="empty-card">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24">
              <use href="#icon-user"></use>
            </svg>
          </div>
          <div class="empty-title">No Candidate Found</div>
          <div class="empty-text">
            No candidate matches "<b>${q}</b>"
          </div>
        </div>
      `);
    }
  });
}
function syncSelectAllState(){
  const selectAll = document.getElementById("wlSelectAll");
  if(!selectAll) return;

  const visibleChecks = Array.from(
    document.querySelectorAll(".wl-row")
  )
  .filter(row => row.style.display !== "none")
  .map(row => row.querySelector(".wl-check"))
  .filter(c => c); // ignore rows without checkbox (voted users)

  if(visibleChecks.length === 0){
    selectAll.checked = false;
    return;
  }

  const allChecked = visibleChecks.every(c => c.checked);
  selectAll.checked = allChecked;
}

function attachWhitelistSearch(){
  const input = document.getElementById("wlSearchInput");
  const list  = document.getElementById("wlList");
  if(!input || !list) return;

  input.addEventListener("input", () => {
    const q = input.value.toLowerCase().trim();
    let visibleCount = 0;

    list.querySelectorAll(".wl-row").forEach(row => {
      const email = row.querySelector(".wl-email")?.innerText.toLowerCase() || "";
      const match = email.includes(q);

      row.style.display = match ? "" : "none";

      const checkbox = row.querySelector(".wl-check");
      if(checkbox){
        if(match){
          if(whitelistSelectionMode){
            checkbox.style.display = "inline-grid";
          }
        } else {
          // just hide visually â€” DO NOT change checked state
          checkbox.style.display = "none";
        }

      }

      if(match) visibleCount++;
    });

    // Remove old empty card
    document.getElementById("wlSearchEmpty")?.remove();

    if(q && visibleCount === 0){
      list.insertAdjacentHTML("beforeend", `
        <div id="wlSearchEmpty" class="empty-card">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24">
              <use href="#icon-mail"></use>
            </svg>
          </div>
          <div class="empty-title">No Whitelist Found</div>
          <div class="empty-text">
            No email matches "<b>${q}</b>"
          </div>
        </div>
      `);
    }

    updateWhitelistUIState();
    syncSelectAllState();

  });
}


attachCandidateSearch();
attachWhitelistSearch();

/* Overview search */
$("#ovPublicSearch")?.addEventListener("input",e=>{
  const q=e.target.value.toLowerCase();
  $$("[data-ov-card]").forEach(c=>{
    if(c.dataset.type!=="public") return;
    c.style.display=(c.dataset.name.includes(q)||c.dataset.code.includes(q))?"":"none";
  });
});
$("#ovPrivateSearch")?.addEventListener("input",e=>{
  const q=e.target.value.toLowerCase();
  $$("[data-ov-card]").forEach(c=>{
    if(c.dataset.type!=="private") return;
    c.style.display=c.dataset.name.includes(q)?"":"none";
  });
});

/* ======================================================
   COUNTDOWN ENGINE (SINGLE INTERVAL)
====================================================== */
function format(ms){
  if(ms<=0) return "00:00:00";
  const s=Math.floor(ms/1000);
  return [
    Math.floor(s/3600),
    Math.floor((s%3600)/60),
    s%60
  ].map(v=>String(v).padStart(2,"0")).join(":");
}
let toastTimeout = null;

function showToast(message,type="success",duration=4000){

  const container=document.getElementById("toastContainer");
  if(!container) return;

  const toast=document.createElement("div");
  toast.className=`toast toast-${type}`;

  toast.innerHTML=`
    <div class="toast-icon">
      ${getToastIcon(type)}
    </div>
    <div>${message}</div>
    <div class="toast-close" onclick="this.parentElement.remove()">âœ•</div>
  `;

  container.appendChild(toast);

  setTimeout(()=>{
    toast.remove();
  },duration);
}

function getToastIcon(type){
  if(type==="success"){
    return `<svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2">
      <path d="M20 6L9 17l-5-5"/>
    </svg>`;
  }
  if(type==="error"){
    return `<svg viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"/>
      <line x1="6" y1="6" x2="18" y2="18"/>
    </svg>`;
  }
  return `<svg viewBox="0 0 24 24" fill="none" stroke="var(--yellow)" stroke-width="2">
    <circle cx="12" cy="12" r="10"/>
  </svg>`;
}


function formatDateTime(ts){
  const d = new Date(ts);
  if(isNaN(d.getTime())) return "";

  return d.toLocaleString(undefined, {
    year: "numeric",
    month: "short",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function updateCountdowns(){
  const now=Date.now();

  $$("[data-election-card]").forEach(card=>{
    const start=card.dataset.start?Date.parse(card.dataset.start):null;
    const end=card.dataset.end?Date.parse(card.dataset.end):null;
    const note=card.querySelector(".election-state-note");
    const timer=card.querySelector(".countdown-timer");

    if(!start&&!end){
      note.textContent="No schedule set";
      timer.textContent="";
      return;
    }
    if(start&&now<start){
      note.textContent="Election not started";
      timer.textContent="Starts in: "+format(start-now);
      return;
    }
    if(end&&now<end){
      note.textContent="Election running";
      timer.textContent="Ends in: "+format(end-now);
      return;
    }
note.textContent = "Election ended";

if(end){
  timer.textContent = "Ended at: " + formatDateTime(end);
} else {
  timer.textContent = "Ended";
}

  });

  $$("[data-ov-card]").forEach(card=>{
    const start=card.dataset.start?Date.parse(card.dataset.start):null;
    const end=card.dataset.end?Date.parse(card.dataset.end):null;
    const timer=card.querySelector(".countdown-timer");
    if(!timer) return;
    if(start&&now<start) timer.textContent="Starts in: "+format(start-now);
    else if(end&&now<end) timer.textContent="Ends in: "+format(end-now);
    else{
  if(end){
    timer.textContent = "Ended at: " + formatDateTime(end);
  } else {
    timer.textContent = "Ended";
  }
}

  });
  updateStatusChips();
}

let timer=null;
function startCountdown(){
  if(timer) return;
  updateCountdowns();
  timer=setInterval(updateCountdowns,1000);
}
document.addEventListener("visibilitychange",()=>{
  document.hidden?clearInterval(timer):startCountdown();
});
startCountdown();
/* ======================================================
   STATUS RESOLVER (single source of truth)
====================================================== */
function getElectionStatus(card){
  const now = Date.now();
  const start = card.dataset.start ? Date.parse(card.dataset.start) : null;
  const end   = card.dataset.end   ? Date.parse(card.dataset.end)   : null;

  if(start && now < start) return "upcoming";
  if(end && now > end) return "ended";
  if(start && end && now >= start && now <= end) return "running";
  return "unknown";
}
function getSortKey(card, mode){
  const status = getElectionStatus(card);
  const start  = card.dataset.start ? Date.parse(card.dataset.start) : Infinity;
  const end    = card.dataset.end   ? Date.parse(card.dataset.end)   : Infinity;
  const now    = Date.now();

  /*
    Lower tuple = higher priority
  */

  // ===== ELECTIONS / OVERVIEW =====
  if(mode === "elections"){
    if(status === "running"){
      return [0, end];           // finishing first
    }
    if(status === "upcoming"){
      return [1, start];         // starting first
    }
    if(status === "ended"){
      return [2, -end];          // last ended first
    }
  }

  // ===== RESULTS =====
  if(mode === "results"){
    if(status === "ended"){
      return [0, -end];          // last ended first
    }
    if(status === "running"){
      return [1, end || Infinity];
    }
    if(status === "upcoming"){
      return [2, start];
    }
  }

  return [9, Infinity];
}
function sortCards(containerSelector, cardSelector, mode){
  const container = document.querySelector(containerSelector);
  if(!container) return;

  const cards = Array.from(container.querySelectorAll(cardSelector));

  cards.sort((a,b)=>{
    const ka = getSortKey(a, mode);
    const kb = getSortKey(b, mode);

    if(ka[0] !== kb[0]) return ka[0] - kb[0];
    return ka[1] - kb[1];
  });

  cards.forEach(c => container.appendChild(c));
}
document.addEventListener("DOMContentLoaded", () => {
  sortCards(
    "#elections .election-grid",
    "[data-election-card]",
    "elections"
  );
});
document.addEventListener("DOMContentLoaded", () => {
  sortCards(
    "#overviewGrid",
    "[data-ov-card]",
    "elections"
  );
});
document.addEventListener("DOMContentLoaded", () => {
  sortCards(
    "#results .election-grid",
    "[data-result-card]",
    "results"
  );
});
/* ======================================================
   ELECTIONS FILTER
====================================================== */
function applyElectionFilters(){
  const q = $("#electionSearch")?.value.toLowerCase() || "";
  const type = $("#electionTypeFilter")?.value || "all";
  const status = $("#electionStatusFilter")?.value || "all";

  const allCards = $$("[data-election-card]");

  // ðŸ”’ If no elections exist at all â†’ do nothing
  if(allCards.length === 0){
    $("#electionsEmpty").style.display = "none";
    return;
  }

  let visible = 0;

  allCards.forEach(card=>{
    const name = card.dataset.name || "";
    const code = card.dataset.code || "";

    const eType = card.dataset.type;
    const eStatus = getElectionStatus(card);

const textMatch =
  name.includes(q) || code.includes(q);

const match =
  textMatch &&
  (type === "all" || eType === type) &&
  (status === "all" || eStatus === status);


    card.style.display = match ? "" : "none";
    if(match) visible++;
  });

  // Show filter-empty only if elections exist
  $("#electionsEmpty").style.display =
    visible === 0 ? "block" : "none";
}



["electionSearch","electionTypeFilter","electionStatusFilter"]
  .forEach(id=>$("#"+id)?.addEventListener("input",applyElectionFilters));
/* ======================================================
   OVERVIEW FILTER
====================================================== */
function applyResultsFilters(){
  const q = $("#resultsSearch")?.value.toLowerCase() || "";
  const type = $("#resultsTypeFilter")?.value || "all";
  const status = $("#resultsStatusFilter")?.value || "all";

  $$("[data-result-card]").forEach(card => {
    const name = card.dataset.name || "";
    const code = card.dataset.code || "";

    const eType = card.dataset.type;
    const eStatus = getElectionStatus(card);
const textMatch =
  name.includes(q) || code.includes(q);

const match =
  textMatch &&
  (type === "all" || eType === type) &&
  (status === "all" || eStatus === status);


    card.style.display = match ? "" : "none";
  });
  const visible = $$("[data-result-card]").filter(c=>c.style.display!=="none").length;
$("#resultsEmpty").style.display = visible === 0 ? "block" : "none";

}

["resultsSearch","resultsTypeFilter","resultsStatusFilter"]
  .forEach(id => $("#"+id)?.addEventListener("input", applyResultsFilters));

function applyOverviewFilters(){
  const q = $("#overviewSearch")?.value.toLowerCase() || "";
  const type = $("#overviewTypeFilter")?.value || "all";
  const status = $("#overviewStatusFilter")?.value || "all";
  
  $$("[data-ov-card]").forEach(card=>{
    const name = card.dataset.name || "";
    const code = card.dataset.code || "";

    const eType = card.dataset.type || "";
    const eStatus = getElectionStatus(card);

const textMatch =
  name.includes(q) || code.includes(q);

const match =
  textMatch &&
  (type === "all" || eType === type) &&
  (status === "all" || eStatus === status);


    card.style.display = match ? "" : "none";
  });
  const visible = $$("[data-ov-card]").filter(c=>c.style.display!=="none").length;
$("#overviewEmpty").style.display = visible === 0 ? "block" : "none";

}

["overviewSearch","overviewTypeFilter","overviewStatusFilter"]
  .forEach(id=>$("#"+id)?.addEventListener("input",applyOverviewFilters));
/* ======================================================
   MOBILE NAV AUTO-HIDE ON SCROLL
====================================================== */
(function(){
  const nav = document.querySelector(".mobile-nav");
  if(!nav) return;

  let lastY = 0;
  let ticking = false;

  function attachScroll(container){
    if(!container) return;

    lastY = container.scrollTop;

    container.addEventListener("scroll", () => {
    if (!ticking) {
      requestAnimationFrame(() => {
        const currentY = container.scrollTop;

        // âœ… iOS elastic scroll guard
        if (currentY <= 0) {
          nav.classList.remove("hidden");
          lastY = 0;
          ticking = false;
          return;
        }

        if (currentY >= container.scrollHeight - container.clientHeight - 1) {
          nav.classList.add("hidden");
          lastY = currentY;
          ticking = false;
          return;
        }

        const delta = currentY - lastY;

        if (Math.abs(delta) > 8) {   // ðŸ”‘ slightly higher threshold
          if (delta > 0) {
            nav.classList.add("hidden");
          } else {
            nav.classList.remove("hidden");
          }
          lastY = currentY;
        }

        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });

  }

  // attach to active view
  function bindActiveView(){
    const active = document.querySelector(".view-container.active");
    if(active){
      attachScroll(active);
    }
  }

  // initial bind
  bindActiveView();

  // rebind on view change
  const _switchView = window.switchView;
  window.switchView = function(viewId){
    _switchView(viewId);
    setTimeout(bindActiveView, 50);
  };
})();

/* ======================================================
   BUTTON LOADING HANDLER
====================================================== */
function enableButtonLoading(){
  document.querySelectorAll("form").forEach(form=>{
    form.addEventListener("submit",e=>{
      const btn = form.querySelector("button[type='submit'], .btn-primary");
      if(!btn) return;

      btn.classList.add("loading");
      btn.disabled = true;
    });
  });

  document.querySelectorAll(".btn").forEach(btn=>{
    if(btn.type === "submit") return;

    btn.addEventListener("click",()=>{
      if(btn.dataset.noLoading) return;
      btn.classList.add("loading");
    });
  });
}

enableButtonLoading();

/* ======================================================
   RESTORE LAST VIEW ON REFRESH
====================================================== */
document.addEventListener("DOMContentLoaded", () => {
  const modalStateRaw = localStorage.getItem("admin_modal");
  const savedView = localStorage.getItem("admin_active_view");
  const params = new URLSearchParams(window.location.search);
  // 1ï¸âƒ£ Modal restoration has TOP priority
  
  if (modalStateRaw) {
    const { type, electionId, electionName } = JSON.parse(modalStateRaw);

    currentViewIndex = VIEW_ORDER.indexOf("elections");
    switchView("elections");

    // wait for view animation/layout
    setTimeout(() => {
      if (type === "candidates") {
        openManageCandidates(electionId, electionName);
      }
      if (type === "whitelist") {
        openWhitelist(electionId, electionName);
      }
    }, 200);

    return; // â›” STOP further view logic
  }

  // 2ï¸âƒ£ Restore last active view
  if (savedView && VIEW_ORDER.includes(savedView)) {
    currentViewIndex = VIEW_ORDER.indexOf(savedView);
    switchView(savedView);
    return;
  }

  // 3ï¸âƒ£ Final fallback
  currentViewIndex = 0;
  switchView("dashboard");
  const urlParams = new URLSearchParams(window.location.search);
  if(urlParams.get("open") === "create"){
    openModal("createElectionModal");
  }


// ---- AUTO OPEN MANAGE CANDIDATES AFTER CREATE ----
if (params.get("open") === "candidates") {
    const eid = params.get("eid");
    const name = params.get("name");

    if (eid && name) {
        // ensure elections view is visible
        switchView("elections");

        // wait for DOM cards to render
        setTimeout(() => {
            openManageCandidates(eid, decodeURIComponent(name));
        }, 200);
    }
}
// ---- AUTO OPEN EDIT ELECTION MODAL ----
if (params.get("open") === "edit") {
  const eid = params.get("eid");
  const name = params.get("name");
  const start = params.get("start");
  const end = params.get("end");

  if (eid && name !== null) {
    setTimeout(() => {
      openEditElection(
        eid,
        decodeURIComponent(name),
        start || "",
        end || ""
      );
    }, 200);
  }
}




});

function rememberModal(type, electionId, electionName){
  localStorage.setItem("admin_modal", JSON.stringify({
    type,
    electionId,
    electionName
  }));
}
function handleResultAccess(id, type, start, end){
  const fakeCard = document.createElement("div");
  fakeCard.dataset.start = start;
  fakeCard.dataset.end = end;

  const status = getElectionStatus(fakeCard);

  // ðŸ”’ Private election â†’ only AFTER end
  if(type === "private" && status !== "ended"){
    showAlert("Results will be available once the private election ends.");
    return;
  }

  // â³ Public election â†’ only AFTER start
  if(type === "public" && status === "upcoming"){
    showAlert("This public election has not started yet.");
    return;
  }

  // âœ… Allowed
  window.location.href = `/admin/results/${id}`;
}
function updateHeaderActions(viewId){
  const actions = document.getElementById("header-actions");
  if(!actions) return;

  // reset
  actions.innerHTML = "";

  // Dashboard / Elections â†’ New Election
  if(viewId === "dashboard" || viewId === "elections" || viewId === "overview"){
    actions.innerHTML = `
      <button class="btn btn-primary"
        onclick="openModal('createElectionModal')">
        + New Election
      </button>
    `;
  }
  if(viewId === "profile"){
    actions.innerHTML = `
<button class="btn btn-danger"
        style="display:flex;align-items:center;gap:8px"
        onclick="openLogoutConfirm()">
  <svg class="icon"><use href="#icon-logout"></use></svg>
  Logout
</button>




    `;
  }
  // Results â†’ View All Results
  if(viewId === "results"){
    actions.innerHTML = `
      <a href="/admin/results">
        <button class="btn btn-primary">
          View All Results
        </button>
      </a>
    `;
  }
}
function toggleEdit(field){
  const row = document.querySelector(
    `.profile-row[data-field="${field}"]`
  );
  if(!row) return;

  if(row.classList.contains("editing")){
    row.classList.remove("editing");
  } else {
    row.classList.add("editing");
  }

  const anyEditing = document.querySelectorAll(".profile-row.editing").length > 0;
  const saveBtn = document.getElementById("saveProfileBtn");

  if(saveBtn){
    saveBtn.style.display = anyEditing ? "inline-flex" : "none";
  }
}

function saveProfile(){

  const nameEl = $("#profileNameInput");
  const userEl = $("#profileUsernameInput");
  const mobEl  = $("#profileMobileInput");
  const waEl   = $("#profileWhatsappInput");
  const saveBtn = $("#saveProfileBtn");

  if(!nameEl || !userEl) return;

  const payload = {
    name: toTitleCase(nameEl.value.trim()),
    username: userEl.value.trim(),
    mobile: mobEl.value.trim(),
    whatsapp: waEl.value.trim()
  };

  // loading state
  saveBtn.classList.add("loading");
  saveBtn.disabled = true;

  fetch("/admin/profile/update",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-CSRFToken":"{{ csrf_token() }}"
    },
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{

    if(!res.success){
      showToast(res.message || "Profile update failed","error");
      saveBtn.classList.remove("loading");
      saveBtn.disabled = false;
      return;
    }

    // Update display values
    $("#profileName").textContent = payload.name;
    $("#profileUsername").textContent = payload.username;
    $("#profileMobile").textContent =
      payload.mobile || "Not set";
    $("#profileWhatsapp").textContent =
      payload.whatsapp || "Not set";

    // Remove editing state
    $$(".profile-row").forEach(r=>{
      r.classList.remove("editing");
    });

    saveBtn.style.display = "none";
    saveBtn.classList.remove("loading");
    saveBtn.disabled = false;

    showToast("Profile updated successfully","success");

  })
  .catch(()=>{
    showToast("Network error","error");
    saveBtn.classList.remove("loading");
    saveBtn.disabled = false;
  });
}

function handleDashboardAlert(action, id, name, start, end){
  // Always go to elections view first
  currentViewIndex = VIEW_ORDER.indexOf("elections");
  switchView("elections");

  setTimeout(() => {
    if(action === "candidates"){
      rememberModal("candidates", id, name);
      openManageCandidates(id, name, start, end);
    }

    if(action === "whitelist"){
      rememberModal("whitelist", id, name);
      openWhitelist(id, name, start, end);
    }

    if(action === "scroll"){
const card = document.querySelector(
  `[data-election-card][data-election-id="${id}"]`
);

      if(card){
        card.scrollIntoView({ behavior:"smooth", block:"center" });
        card.style.boxShadow = "0 0 0 2px var(--yellow)";
        setTimeout(()=>card.style.boxShadow="",1200);
      }
    }
  }, 250);
}
/* ======================================================
   STATUS CHIP ENGINE (AUTO-UPDATE)
====================================================== */
function updateStatusChips(){
  $$("[data-status-chip]").forEach(chip=>{
    const card = chip.closest("[data-start], [data-result-card]");
    if(!card) return;

    const status = getElectionStatus(card);

    chip.className = "status-chip"; // reset

    if(status === "upcoming"){
      chip.textContent = "UPCOMING";
      chip.classList.add("status-upcoming");
    }
    else if(status === "running"){
      chip.textContent = "RUNNING";
      chip.classList.add("status-running");
    }
    else if(status === "ended"){
      chip.textContent = "ENDED";
      chip.classList.add("status-ended");
    }
  });
}
function openLogoutConfirm(){
  const m = document.getElementById("logoutConfirmModal");
  if(!m) return;

  m.style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeLogoutConfirm(){
  const m = document.getElementById("logoutConfirmModal");
  if(!m) return;

  m.style.display = "none";
  document.body.style.overflow = "auto";
}

function confirmLogout(){
  localStorage.removeItem("admin_active_view");
  localStorage.removeItem("admin_modal");
  window.location.href = "/logout";
}
function toTitleCase(str){
  return str
    .toLowerCase()
    .split(" ")
    .filter(w => w.length > 0)
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

</script>
<script>
function validateSquareImage(file, callback){
  if(!file) return callback(true);

  const img = new Image();
  const reader = new FileReader();

  reader.onload = e => {
    img.onload = () => {
      if(img.width !== img.height){
        showAlert("Image must be a square (1:1 ratio). Please upload a proper image.");
        callback(false);
      } else {
        callback(true);
      }
    };
    img.src = e.target.result;
  };

  reader.readAsDataURL(file);
}
</script>
<script>
function handleCandidateImageSubmit(form){
  const fileInput = form.querySelector("input[type='file']");
  const file = fileInput?.files[0];

  if(!file) return true; // no image â†’ allow

  validateSquareImage(file, ok => {
    if(ok) form.submit();
  });

  return false; // stop default submit
}
function confirmBulkDelete(){
  const ids = Array.from(
    document.querySelectorAll(".wl-check:checked")
  ).map(c => c.value);

  if(ids.length === 0){
    showAlert("Select at least one email to delete.");
    return;
  }
  openConfirm(
    `Delete ${ids.length} selected whitelist entries?`,
    () => submitBulkDelete(ids),
    "danger"
  );

}

function submitBulkDelete(ids){
  fetch("/admin/whitelist/bulk-delete",{
    method:"POST",
    headers:{ "Content-Type":"application/json","X-CSRFToken":"{{ csrf_token() }}" },
    body:JSON.stringify({ ids })
  })
  .then(r => r.json())
  .then(res => {
    if(!res.success){
      showAlert(res.message || "Delete failed");
      return;
    }

    // refresh whitelist
    openWhitelist(
      $("#wlElectionId").value,
      $("#wlTitle").textContent.replace("Whitelist â€” ","")
    );
  })
  .catch(() => showAlert("Network error"));
}

</script>

</body>
</html>